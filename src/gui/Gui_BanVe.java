/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JPanel.java to edit this template
 */
package gui;

import dao.*;
import entity.*;
import javax.swing.*;
import javax.swing.table.DefaultTableModel;
import java.awt.*;
import java.awt.event.*;
import javax.swing.event.*;
import java.time.LocalDate;
import java.time.ZoneId;
import java.util.*;
import java.util.List;

/**
 * @description: Giao di·ªán b√°n v√© t√†u
 * @author PC
 */
public class Gui_BanVe extends javax.swing.JPanel {

    // DAOs
    private Ga_DAO gaDAO;
    private LichTrinh_DAO lichTrinhDAO;
    private Toa_DAO toaDAO;
    private ChoNgoi_DAO choNgoiDAO;
    private KhachHang_DAO khachHangDAO;
    private Ve_DAO veDAO;
    
    // Data
    private List<LichTrinh> danhSachLichTrinh;
    private LichTrinh lichTrinhDangChon;
    private Toa toaDangChon;
    private List<ChoNgoi> danhSachGheDangChon;
    private Map<ChoNgoi, LichTrinh> mapGheLichTrinh; // L∆∞u l·ªãch tr√¨nh c·ªßa t·ª´ng gh·∫ø ƒë√£ ch·ªçn
    
    // L∆∞u ga g·ªëc ƒë·ªÉ swap khi chuy·ªÉn chi·ªÅu
    private String gaDiGoc;
    private String gaDenGoc;
    private Date ngayDiGoc;
    private Date ngayVeGoc;
    
    // Models
    private DefaultTableModel modelGioVe;
    private ButtonGroup groupChieu;
    private ButtonGroup groupLoaiVe;

    /**
     * Creates new form Gui_BanVe
     */
    public Gui_BanVe() {
        initComponents();
        initDAO();
        initCustomComponents();
    }
    
    /**
     * Constructor nh·∫≠n th√¥ng tin h√†nh tr√¨nh t·ª´ form nh·∫≠p
     */
    public Gui_BanVe(Gui_NhapThongTinHanhTrinh.ThongTinHanhTrinh info) {
        initComponents();
        initDAO();
        initCustomComponents();
        
        // ƒêi·ªÅn th√¥ng tin t·ª± ƒë·ªông
        txtGaDi.setText(info.getGaDi());
        txtGaDen.setText(info.getGaDen());
        dchNgayDi.setDate(info.getNgayDi());
        dchNgayVe.setDate(info.getNgayVe());
        
        if (info.isMotChieu()) {
            radMotChieu.setSelected(true);
            dchNgayVe.setEnabled(false);
        } else {
            radKhuHoi.setSelected(true);
            dchNgayVe.setEnabled(true);
            
            // ‚ö° L∆ØU TH√îNG TIN G·ªêC CHO KH·ª® H·ªíI (ƒë·ªÉ swap chi·ªÅu ƒëi/v·ªÅ)
            gaDiGoc = info.getGaDi();
            gaDenGoc = info.getGaDen();
            ngayDiGoc = info.getNgayDi();
            ngayVeGoc = info.getNgayVe();
        }
        
        // T·ª± ƒë·ªông t√¨m ki·∫øm
        SwingUtilities.invokeLater(() -> {
            btnTimKiemActionPerformed(null);
        });
    }
    
    /**
     * Kh·ªüi t·∫°o c√°c DAO
     */
    private void initDAO() {
        gaDAO = new Ga_DAO();
        lichTrinhDAO = new LichTrinh_DAO();
        toaDAO = new Toa_DAO();
        choNgoiDAO = new ChoNgoi_DAO();
        khachHangDAO = new KhachHang_DAO();
        veDAO = new Ve_DAO();
    }
    
    /**
     * Kh·ªüi t·∫°o c√°c component t√πy ch·ªânh
     */
    private void initCustomComponents() {
        // Kh·ªüi t·∫°o danh s√°ch gh·∫ø ƒëang ch·ªçn
        danhSachGheDangChon = new ArrayList<>();
        mapGheLichTrinh = new java.util.LinkedHashMap<>(); // Kh·ªüi t·∫°o map l∆∞u l·ªãch tr√¨nh c·ªßa t·ª´ng gh·∫ø
        
        // Group radio buttons
        groupChieu = new ButtonGroup();
        groupChieu.add(radMotChieu);
        groupChieu.add(radKhuHoi);
        radMotChieu.setSelected(true);
        
        ButtonGroup groupChieuMua = new ButtonGroup();
        groupChieuMua.add(radChieuDi);
        groupChieuMua.add(radChieuVe);
        radChieuDi.setSelected(true);
        
        // Th√™m listener cho radio button chi·ªÅu
        radChieuVe.addActionListener(e -> chuyenChieuVe());
        radChieuDi.addActionListener(e -> chuyenChieuDi());
        
        // Setup table gi·ªè v√©
        modelGioVe = (DefaultTableModel) tblGioVe.getModel();
        modelGioVe.setRowCount(0);
        
        // Set ng√†y m·∫∑c ƒë·ªãnh
        dchNgayDi.setDate(new Date());
        dchNgayVe.setDate(new Date());
        
        // Disable ng√†y v·ªÅ ban ƒë·∫ßu
        dchNgayVe.setEnabled(false);
        radKhuHoi.addActionListener(e -> dchNgayVe.setEnabled(radKhuHoi.isSelected()));
        radMotChieu.addActionListener(e -> dchNgayVe.setEnabled(false));
        
        // ·∫®n c√°c panel k·∫øt qu·∫£ ban ƒë·∫ßu
        pnlTuyen.setVisible(false);
        pnlToaTau.setVisible(false);
        pnlSoDoGhe.setVisible(false);
        pnlChieuMuaVe.setVisible(false);
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        pnlThongTinHanhTrinh = new javax.swing.JPanel();
        lblGaDi = new javax.swing.JLabel();
        lblGaDen = new javax.swing.JLabel();
        btnTimKiem = new javax.swing.JButton();
        radMotChieu = new javax.swing.JRadioButton();
        radKhuHoi = new javax.swing.JRadioButton();
        lblNgayDi = new javax.swing.JLabel();
        lblNgayVe = new javax.swing.JLabel();
        txtGaDi = new javax.swing.JTextField();
        txtGaDen = new javax.swing.JTextField();
        dchNgayDi = new com.toedter.calendar.JDateChooser();
        dchNgayVe = new com.toedter.calendar.JDateChooser();
        pnlGioVe = new javax.swing.JPanel();
        btnMuaVe = new javax.swing.JButton();
        btnHuyCho = new javax.swing.JButton();
        scrGioVe = new javax.swing.JScrollPane();
        tblGioVe = new javax.swing.JTable();
        btnHuyTatCa = new javax.swing.JButton();
        pnlChieuMuaVe = new javax.swing.JPanel();
        radChieuDi = new javax.swing.JRadioButton();
        radChieuVe = new javax.swing.JRadioButton();
        pnlTuyen = new javax.swing.JPanel();
        pnlToaTau = new javax.swing.JPanel();
        pnlSoDoGhe = new javax.swing.JPanel();
        jLabel5 = new javax.swing.JLabel();
        jPanel7 = new javax.swing.JPanel();
        jPanel8 = new javax.swing.JPanel();
        jPanel9 = new javax.swing.JPanel();
        jLabel6 = new javax.swing.JLabel();
        btnXuLyDonTam = new javax.swing.JButton();
        jLabel1 = new javax.swing.JLabel();
        jPanel1 = new javax.swing.JPanel();
        jLabel7 = new javax.swing.JLabel();

        setBackground(new java.awt.Color(234, 243, 251));
        setToolTipText("");

        pnlThongTinHanhTrinh.setBackground(new java.awt.Color(255, 255, 255));
        pnlThongTinHanhTrinh.setBorder(javax.swing.BorderFactory.createTitledBorder("Th√¥ng Tin H√†nh Tr√¨nh"));

        lblGaDi.setFont(new java.awt.Font("Segoe UI", 0, 14)); // NOI18N
        lblGaDi.setText("Ga ƒëi:");

        lblGaDen.setFont(new java.awt.Font("Segoe UI", 0, 14)); // NOI18N
        lblGaDen.setText("Ga ƒë·∫øn:");

        btnTimKiem.setIcon(new javax.swing.ImageIcon(getClass().getResource("/icon/TimKiem.png"))); // NOI18N
        btnTimKiem.setText("T√¨m Ki·∫øm");
        btnTimKiem.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnTimKiemActionPerformed(evt);
            }
        });

        radMotChieu.setFont(new java.awt.Font("Segoe UI", 0, 14)); // NOI18N
        radMotChieu.setText("M·ªôt chi·ªÅu");
        radMotChieu.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                radMotChieuActionPerformed(evt);
            }
        });

        radKhuHoi.setFont(new java.awt.Font("Segoe UI", 0, 14)); // NOI18N
        radKhuHoi.setText("Kh·ª© h·ªìi");

        lblNgayDi.setFont(new java.awt.Font("Segoe UI", 0, 14)); // NOI18N
        lblNgayDi.setText("Ng√†y ƒëi:");

        lblNgayVe.setFont(new java.awt.Font("Segoe UI", 0, 14)); // NOI18N
        lblNgayVe.setText("Ng√†y v·ªÅ:");

        txtGaDen.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                txtGaDenActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout pnlThongTinHanhTrinhLayout = new javax.swing.GroupLayout(pnlThongTinHanhTrinh);
        pnlThongTinHanhTrinh.setLayout(pnlThongTinHanhTrinhLayout);
        pnlThongTinHanhTrinhLayout.setHorizontalGroup(
            pnlThongTinHanhTrinhLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnlThongTinHanhTrinhLayout.createSequentialGroup()
                .addGroup(pnlThongTinHanhTrinhLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(pnlThongTinHanhTrinhLayout.createSequentialGroup()
                        .addGap(51, 51, 51)
                        .addGroup(pnlThongTinHanhTrinhLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(pnlThongTinHanhTrinhLayout.createSequentialGroup()
                                .addGroup(pnlThongTinHanhTrinhLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                    .addComponent(lblGaDi)
                                    .addComponent(lblGaDen))
                                .addGap(35, 35, 35)
                                .addGroup(pnlThongTinHanhTrinhLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                                    .addComponent(txtGaDi, javax.swing.GroupLayout.DEFAULT_SIZE, 191, Short.MAX_VALUE)
                                    .addComponent(txtGaDen)))
                            .addGroup(pnlThongTinHanhTrinhLayout.createSequentialGroup()
                                .addGroup(pnlThongTinHanhTrinhLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                    .addComponent(lblNgayVe)
                                    .addComponent(lblNgayDi))
                                .addGap(27, 27, 27)
                                .addGroup(pnlThongTinHanhTrinhLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                                    .addComponent(dchNgayDi, javax.swing.GroupLayout.DEFAULT_SIZE, 192, Short.MAX_VALUE)
                                    .addComponent(dchNgayVe, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)))))
                    .addGroup(pnlThongTinHanhTrinhLayout.createSequentialGroup()
                        .addGap(106, 106, 106)
                        .addComponent(radMotChieu)
                        .addGap(28, 28, 28)
                        .addComponent(radKhuHoi)))
                .addContainerGap(77, Short.MAX_VALUE))
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, pnlThongTinHanhTrinhLayout.createSequentialGroup()
                .addGap(0, 0, Short.MAX_VALUE)
                .addComponent(btnTimKiem)
                .addGap(120, 120, 120))
        );
        pnlThongTinHanhTrinhLayout.setVerticalGroup(
            pnlThongTinHanhTrinhLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnlThongTinHanhTrinhLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(pnlThongTinHanhTrinhLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(txtGaDi, javax.swing.GroupLayout.PREFERRED_SIZE, 30, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(lblGaDi, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                .addGap(25, 25, 25)
                .addGroup(pnlThongTinHanhTrinhLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblGaDen)
                    .addComponent(txtGaDen, javax.swing.GroupLayout.PREFERRED_SIZE, 30, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addGroup(pnlThongTinHanhTrinhLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(radMotChieu)
                    .addComponent(radKhuHoi))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addGroup(pnlThongTinHanhTrinhLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(lblNgayDi)
                    .addComponent(dchNgayDi, javax.swing.GroupLayout.PREFERRED_SIZE, 30, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(28, 28, 28)
                .addGroup(pnlThongTinHanhTrinhLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(dchNgayVe, javax.swing.GroupLayout.PREFERRED_SIZE, 30, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(lblNgayVe))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(btnTimKiem, javax.swing.GroupLayout.PREFERRED_SIZE, 40, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(18, 18, 18))
        );

        pnlGioVe.setBackground(new java.awt.Color(255, 255, 255));
        pnlGioVe.setBorder(javax.swing.BorderFactory.createTitledBorder("Gi·ªè V√©"));

        btnMuaVe.setIcon(new javax.swing.ImageIcon(getClass().getResource("/icon/ticket.png"))); // NOI18N
        btnMuaVe.setText("Mua V√©");
        btnMuaVe.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnMuaVeActionPerformed(evt);
            }
        });

        btnHuyCho.setIcon(new javax.swing.ImageIcon(getClass().getResource("/icon/trash.png"))); // NOI18N
        btnHuyCho.setText("H·ªßy Ch·ªó");
        btnHuyCho.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnHuyChoActionPerformed(evt);
            }
        });

        tblGioVe.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "Tuy·∫øn", "Ch·ªó ng·ªìi", "Chi·ªÅu "
            }
        ));
        scrGioVe.setViewportView(tblGioVe);

        btnHuyTatCa.setIcon(new javax.swing.ImageIcon(getClass().getResource("/icon/clear.png"))); // NOI18N
        btnHuyTatCa.setText("H·ªßy T·∫•t C·∫£");
        btnHuyTatCa.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnHuyTatCaActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout pnlGioVeLayout = new javax.swing.GroupLayout(pnlGioVe);
        pnlGioVe.setLayout(pnlGioVeLayout);
        pnlGioVeLayout.setHorizontalGroup(
            pnlGioVeLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnlGioVeLayout.createSequentialGroup()
                .addGap(0, 0, Short.MAX_VALUE)
                .addComponent(btnMuaVe, javax.swing.GroupLayout.PREFERRED_SIZE, 110, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(btnHuyCho)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(btnHuyTatCa)
                .addGap(12, 12, 12))
            .addComponent(scrGioVe, javax.swing.GroupLayout.DEFAULT_SIZE, 402, Short.MAX_VALUE)
        );
        pnlGioVeLayout.setVerticalGroup(
            pnlGioVeLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnlGioVeLayout.createSequentialGroup()
                .addComponent(scrGioVe, javax.swing.GroupLayout.DEFAULT_SIZE, 286, Short.MAX_VALUE)
                .addGap(12, 12, 12)
                .addGroup(pnlGioVeLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(btnMuaVe, javax.swing.GroupLayout.PREFERRED_SIZE, 38, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(btnHuyCho, javax.swing.GroupLayout.PREFERRED_SIZE, 38, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(btnHuyTatCa, javax.swing.GroupLayout.PREFERRED_SIZE, 38, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(17, 17, 17))
        );

        pnlChieuMuaVe.setBackground(new java.awt.Color(255, 255, 255));
        pnlChieuMuaVe.setBorder(javax.swing.BorderFactory.createTitledBorder("Chi·ªÅu mua v√©"));

        radChieuDi.setText("Chi·ªÅu ƒëi");
        radChieuDi.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                radChieuDiActionPerformed(evt);
            }
        });

        radChieuVe.setText("Chi·ªÅu V·ªÅ");

        javax.swing.GroupLayout pnlChieuMuaVeLayout = new javax.swing.GroupLayout(pnlChieuMuaVe);
        pnlChieuMuaVe.setLayout(pnlChieuMuaVeLayout);
        pnlChieuMuaVeLayout.setHorizontalGroup(
            pnlChieuMuaVeLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnlChieuMuaVeLayout.createSequentialGroup()
                .addGap(229, 229, 229)
                .addComponent(radChieuDi)
                .addGap(185, 185, 185)
                .addComponent(radChieuVe)
                .addContainerGap(849, Short.MAX_VALUE))
        );
        pnlChieuMuaVeLayout.setVerticalGroup(
            pnlChieuMuaVeLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, pnlChieuMuaVeLayout.createSequentialGroup()
                .addContainerGap(8, Short.MAX_VALUE)
                .addGroup(pnlChieuMuaVeLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(radChieuDi, javax.swing.GroupLayout.PREFERRED_SIZE, 37, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(radChieuVe))
                .addGap(16, 16, 16))
        );

        pnlTuyen.setBackground(new java.awt.Color(255, 255, 255));

        javax.swing.GroupLayout pnlTuyenLayout = new javax.swing.GroupLayout(pnlTuyen);
        pnlTuyen.setLayout(pnlTuyenLayout);
        pnlTuyenLayout.setHorizontalGroup(
            pnlTuyenLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 1408, Short.MAX_VALUE)
        );
        pnlTuyenLayout.setVerticalGroup(
            pnlTuyenLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 176, Short.MAX_VALUE)
        );

        pnlToaTau.setBackground(new java.awt.Color(255, 255, 255));

        javax.swing.GroupLayout pnlToaTauLayout = new javax.swing.GroupLayout(pnlToaTau);
        pnlToaTau.setLayout(pnlToaTauLayout);
        pnlToaTauLayout.setHorizontalGroup(
            pnlToaTauLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 0, Short.MAX_VALUE)
        );
        pnlToaTauLayout.setVerticalGroup(
            pnlToaTauLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 65, Short.MAX_VALUE)
        );

        pnlSoDoGhe.setBackground(new java.awt.Color(255, 255, 255));

        javax.swing.GroupLayout pnlSoDoGheLayout = new javax.swing.GroupLayout(pnlSoDoGhe);
        pnlSoDoGhe.setLayout(pnlSoDoGheLayout);
        pnlSoDoGheLayout.setHorizontalGroup(
            pnlSoDoGheLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 0, Short.MAX_VALUE)
        );
        pnlSoDoGheLayout.setVerticalGroup(
            pnlSoDoGheLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 490, Short.MAX_VALUE)
        );

        jLabel5.setText("Gh·∫ø ƒëang ch·ªçn");

        jPanel7.setBackground(new java.awt.Color(255, 51, 51));

        javax.swing.GroupLayout jPanel7Layout = new javax.swing.GroupLayout(jPanel7);
        jPanel7.setLayout(jPanel7Layout);
        jPanel7Layout.setHorizontalGroup(
            jPanel7Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 46, Short.MAX_VALUE)
        );
        jPanel7Layout.setVerticalGroup(
            jPanel7Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 15, Short.MAX_VALUE)
        );

        jPanel8.setBackground(new java.awt.Color(153, 204, 255));

        javax.swing.GroupLayout jPanel8Layout = new javax.swing.GroupLayout(jPanel8);
        jPanel8.setLayout(jPanel8Layout);
        jPanel8Layout.setHorizontalGroup(
            jPanel8Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 42, Short.MAX_VALUE)
        );
        jPanel8Layout.setVerticalGroup(
            jPanel8Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 15, Short.MAX_VALUE)
        );

        jPanel9.setBackground(new java.awt.Color(102, 255, 102));

        javax.swing.GroupLayout jPanel9Layout = new javax.swing.GroupLayout(jPanel9);
        jPanel9.setLayout(jPanel9Layout);
        jPanel9Layout.setHorizontalGroup(
            jPanel9Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 46, Short.MAX_VALUE)
        );
        jPanel9Layout.setVerticalGroup(
            jPanel9Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 16, Short.MAX_VALUE)
        );

        jLabel6.setText("Gh·∫ø ƒë√£ b√°n");

        btnXuLyDonTam.setIcon(new javax.swing.ImageIcon(getClass().getResource("/icon/document-management.png"))); // NOI18N
        btnXuLyDonTam.setText("X·ª≠ l√≠ ƒë∆°n t·∫°m");
        btnXuLyDonTam.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnXuLyDonTamActionPerformed(evt);
            }
        });

        jLabel1.setText("Gh·∫ø ƒëanng gi·ªØ ch·ªó");

        jPanel1.setBackground(new java.awt.Color(255, 255, 0));
        jPanel1.setForeground(new java.awt.Color(255, 204, 51));

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 49, Short.MAX_VALUE)
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 14, Short.MAX_VALUE)
        );

        jLabel7.setText("Toa ƒëang ch·ªçn");

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(pnlChieuMuaVe, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .addComponent(pnlTuyen, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .addComponent(pnlToaTau, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .addComponent(pnlSoDoGhe, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .addGroup(layout.createSequentialGroup()
                                .addGap(59, 59, 59)
                                .addComponent(jLabel5)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                                .addComponent(jPanel8, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addGap(59, 59, 59)
                                .addComponent(jLabel6)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(jPanel7, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addGap(74, 74, 74)
                                .addComponent(jLabel1)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                                .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addGap(49, 49, 49)
                                .addComponent(jLabel7)
                                .addGap(26, 26, 26)
                                .addComponent(jPanel9, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addGap(0, 0, Short.MAX_VALUE)))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED))
                    .addGroup(layout.createSequentialGroup()
                        .addGap(307, 307, 307)
                        .addComponent(btnXuLyDonTam, javax.swing.GroupLayout.PREFERRED_SIZE, 157, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)))
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addComponent(pnlThongTinHanhTrinh, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(pnlGioVe, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
            .addGroup(layout.createSequentialGroup()
                .addComponent(pnlThongTinHanhTrinh, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(pnlGioVe, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
            .addGroup(layout.createSequentialGroup()
                .addComponent(pnlTuyen, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(pnlToaTau, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(18, 18, 18)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                    .addComponent(jLabel5)
                    .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                        .addComponent(jLabel6)
                        .addComponent(jPanel8, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addComponent(jLabel1)
                    .addComponent(jLabel7)
                    .addComponent(jPanel9, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jPanel1, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jPanel7, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(pnlSoDoGhe, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(pnlChieuMuaVe, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(18, 18, 18)
                .addComponent(btnXuLyDonTam)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
    }// </editor-fold>//GEN-END:initComponents

    private void btnMuaVeActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnMuaVeActionPerformed
        // Ki·ªÉm tra gi·ªè v√© c√≥ v√© kh√¥ng
        if (modelGioVe.getRowCount() == 0) {
            JOptionPane.showMessageDialog(this, 
                "Gi·ªè v√© ƒëang tr·ªëng!\nVui l√≤ng ch·ªçn gh·∫ø/gi∆∞·ªùng tr∆∞·ªõc khi mua v√©.", 
                "Th√¥ng b√°o", 
                JOptionPane.WARNING_MESSAGE);
            return;
        }
        
        // Ki·ªÉm tra ƒë√£ ch·ªçn l·ªãch tr√¨nh ch∆∞a
        if (lichTrinhDangChon == null) {
            JOptionPane.showMessageDialog(this, 
                "L·ªói: Ch∆∞a ch·ªçn l·ªãch tr√¨nh!", 
                "L·ªói", 
                JOptionPane.ERROR_MESSAGE);
            return;
        }
        
        // Chuy·ªÉn sang m√†n h√¨nh nh·∫≠p th√¥ng tin b√°n v√©
        // Truy·ªÅn instance hi·ªán t·∫°i ƒë·ªÉ c√≥ th·ªÉ quay l·∫°i v·ªõi d·ªØ li·ªáu gi·ªØ nguy√™n
        gui.menu.form.MainForm mainForm = (gui.menu.form.MainForm) this.getParent();
        mainForm.showForm(new Gui_NhapThongTinBanVe(this));
    }//GEN-LAST:event_btnMuaVeActionPerformed

    private void btnHuyChoActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnHuyChoActionPerformed
        int selectedRow = tblGioVe.getSelectedRow();
        if (selectedRow == -1) {
            JOptionPane.showMessageDialog(this, "Vui l√≤ng ch·ªçn v√© c·∫ßn h·ªßy!", "Th√¥ng b√°o", JOptionPane.WARNING_MESSAGE);
            return;
        }
        
        // L·∫•y th√¥ng tin v√© t·ª´ b·∫£ng - C·ªôt 1 l√† "Ch·ªó ng·ªìi"
        String choNgoiStr = (String) modelGioVe.getValueAt(selectedRow, 1); // "Toa X - Gh·∫ø Y"
        
        // Parse ƒë·ªÉ l·∫•y s·ªë toa v√† v·ªã tr√≠
        try {
            String[] parts = choNgoiStr.split(" - Gh·∫ø ");
            int soToa = Integer.parseInt(parts[0].replace("Toa ", "").trim());
            int viTri = Integer.parseInt(parts[1].trim());
            
            // T√¨m ChoNgoi trong danh s√°ch ƒëang ch·ªçn
            ChoNgoi choCanXoa = null;
            for (ChoNgoi cho : danhSachGheDangChon) {
                if (cho.getToa().getSoToa() == soToa && cho.getViTri() == viTri) {
                    choCanXoa = cho;
                    break;
                }
            }
            
            if (choCanXoa != null) {
                // X√≥a kh·ªèi danh s√°ch
                danhSachGheDangChon.remove(choCanXoa);
                
                // X√≥a kh·ªèi b·∫£ng
                modelGioVe.removeRow(selectedRow);
                
                // Refresh s∆° ƒë·ªì gh·∫ø ƒë·ªÉ c·∫≠p nh·∫≠t m√†u
                if (toaDangChon != null && lichTrinhDangChon != null) {
                    hienThiSoDoGheTrongPanel(toaDangChon, lichTrinhDangChon);
                }
            }
        } catch (Exception e) {
            JOptionPane.showMessageDialog(this, "L·ªói khi h·ªßy v√©: " + e.getMessage(), "L·ªói", JOptionPane.ERROR_MESSAGE);
            e.printStackTrace();
        }
    }//GEN-LAST:event_btnHuyChoActionPerformed

    private void btnTimKiemActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnTimKiemActionPerformed
        // Validate input
        String gaDi = txtGaDi.getText().trim();
        String gaDen = txtGaDen.getText().trim();
        Date ngayDi = dchNgayDi.getDate();
        
        if (gaDi.isEmpty()) {
            JOptionPane.showMessageDialog(this, "Vui l√≤ng nh·∫≠p ga ƒëi!", "Th√¥ng b√°o", JOptionPane.WARNING_MESSAGE);
            txtGaDi.requestFocus();
            return;
        }
        
        if (gaDen.isEmpty()) {
            JOptionPane.showMessageDialog(this, "Vui l√≤ng nh·∫≠p ga ƒë·∫øn!", "Th√¥ng b√°o", JOptionPane.WARNING_MESSAGE);
            txtGaDen.requestFocus();
            return;
        }
        
        if (ngayDi == null) {
            JOptionPane.showMessageDialog(this, "Vui l√≤ng ch·ªçn ng√†y ƒëi!", "Th√¥ng b√°o", JOptionPane.WARNING_MESSAGE);
            return;
        }
        
        if (gaDi.equalsIgnoreCase(gaDen)) {
            JOptionPane.showMessageDialog(this, "Ga ƒëi v√† ga ƒë·∫øn kh√¥ng ƒë∆∞·ª£c tr√πng nhau!", "Th√¥ng b√°o", JOptionPane.WARNING_MESSAGE);
            return;
        }
        
        // Convert Date to LocalDate
        LocalDate localNgayDi = ngayDi.toInstant().atZone(ZoneId.systemDefault()).toLocalDate();
        
        // T√¨m l·ªãch tr√¨nh
        danhSachLichTrinh = lichTrinhDAO.timLichTrinh(gaDi, gaDen, localNgayDi);
        
        if (danhSachLichTrinh == null || danhSachLichTrinh.isEmpty()) {
            JOptionPane.showMessageDialog(this, 
                "Kh√¥ng t√¨m th·∫•y chuy·∫øn t√†u n√†o ph√π h·ª£p!\nVui l√≤ng th·ª≠ l·∫°i v·ªõi th√¥ng tin kh√°c.", 
                "Th√¥ng b√°o", JOptionPane.INFORMATION_MESSAGE);
            anPanelKetQua();
            return;
        }
        
        // L∆∞u l·∫°i th√¥ng tin g·ªëc ƒë·ªÉ swap khi chuy·ªÉn chi·ªÅu
        if (radChieuDi.isSelected()) {
            gaDiGoc = gaDi;
            gaDenGoc = gaDen;
            ngayDiGoc = ngayDi;
            ngayVeGoc = dchNgayVe.getDate();
        }
        
        // Hi·ªÉn th·ªã panel tuy·∫øn
        pnlTuyen.setVisible(true);
        
        // Auto ch·ªçn chuy·∫øn c√≥ gi·ªù xu·∫•t ph√°t s·ªõm nh·∫•t TR∆Ø·ªöC
        if (!danhSachLichTrinh.isEmpty()) {
            lichTrinhDangChon = timChuyenXuatPhatSomNhat(danhSachLichTrinh);
            
            // üîç DEBUG: Log l·ªãch tr√¨nh auto ch·ªçn
            if (lichTrinhDangChon != null) {
                System.out.println("üîÑ Auto ch·ªçn chuy·∫øn s·ªõm nh·∫•t: L·ªãch tr√¨nh " + lichTrinhDangChon.getMaLichTrinh() + 
                    " | Gi·ªù KH: " + (lichTrinhDangChon.getGioKhoiHanh() != null ? lichTrinhDangChon.getGioKhoiHanh() : "null"));
            }
        }
        
        // SAU ƒê√ì m·ªõi hi·ªÉn th·ªã danh s√°ch chuy·∫øn t√†u (ƒë·ªÉ render ƒë√∫ng m√†u)
        hienThiDanhSachChuyenTauTrongPanel(danhSachLichTrinh);
        
        // Hi·ªÉn th·ªã danh s√°ch toa c·ªßa chuy·∫øn ƒë√£ ch·ªçn
        if (lichTrinhDangChon != null) {
            hienThiDanhSachToaTrongPanel(lichTrinhDangChon);
        }
    }//GEN-LAST:event_btnTimKiemActionPerformed

    private void radMotChieuActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_radMotChieuActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_radMotChieuActionPerformed

    private void txtGaDenActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_txtGaDenActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_txtGaDenActionPerformed

    private void btnHuyTatCaActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnHuyTatCaActionPerformed
        if (modelGioVe.getRowCount() == 0) {
            JOptionPane.showMessageDialog(this, "Gi·ªè v√© ƒëang tr·ªëng!", "Th√¥ng b√°o", JOptionPane.INFORMATION_MESSAGE);
            return;
        }
        
        int confirm = JOptionPane.showConfirmDialog(this, 
            "B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ v√© trong gi·ªè?", 
            "X√°c nh·∫≠n", JOptionPane.YES_NO_OPTION);
        
        if (confirm == JOptionPane.YES_OPTION) {
            modelGioVe.setRowCount(0);
            danhSachGheDangChon.clear();
            
            // Refresh s∆° ƒë·ªì gh·∫ø
            if (toaDangChon != null && lichTrinhDangChon != null) {
                hienThiSoDoGheTrongPanel(toaDangChon, lichTrinhDangChon);
            }
        }
    }//GEN-LAST:event_btnHuyTatCaActionPerformed

    private void radChieuDiActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_radChieuDiActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_radChieuDiActionPerformed

    private void btnXuLyDonTamActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnXuLyDonTamActionPerformed
        // M·ªü Dialog Treo ƒê∆°n
        java.awt.Frame parentFrame = (java.awt.Frame) javax.swing.SwingUtilities.getWindowAncestor(this);
        Dialog_TreoDon dialogTreoDon = new Dialog_TreoDon(parentFrame, true);
        dialogTreoDon.setVisible(true);
        
        // Sau khi ƒë√≥ng dialog (h·ªßy ƒë∆°n ho·∫∑c x·ª≠ l√Ω), reload l·∫°i s∆° ƒë·ªì gh·∫ø
        if (toaDangChon != null && lichTrinhDangChon != null) {
            hienThiSoDoGheTrongPanel(toaDangChon, lichTrinhDangChon);
        }
    }//GEN-LAST:event_btnXuLyDonTamActionPerformed

    // ==================== HELPER METHODS ====================
    
    /**
     * ·∫®n c√°c panel k·∫øt qu·∫£
     */
    private void anPanelKetQua() {
        pnlTuyen.setVisible(false);
        pnlToaTau.setVisible(false);
        pnlSoDoGhe.setVisible(false);
        pnlChieuMuaVe.setVisible(false);
    }
    
    /**
     * T√¨m chuy·∫øn t√†u c√≥ gi·ªù xu·∫•t ph√°t s·ªõm nh·∫•t
     */
    private LichTrinh timChuyenXuatPhatSomNhat(List<LichTrinh> danhSach) {
        if (danhSach == null || danhSach.isEmpty()) {
            return null;
        }
        
        LichTrinh somNhat = danhSach.get(0);
        
        for (LichTrinh lt : danhSach) {
            if (lt.getGioKhoiHanh() != null && somNhat.getGioKhoiHanh() != null) {
                if (lt.getGioKhoiHanh().isBefore(somNhat.getGioKhoiHanh())) {
                    somNhat = lt;
                }
            }
        }
        
        return somNhat;
    }
    
    /**
     * Hi·ªÉn th·ªã danh s√°ch chuy·∫øn t√†u trong panel (chi·ªÅu ngang v·ªõi n√∫t scroll)
     */
    private void hienThiDanhSachChuyenTauTrongPanel(List<LichTrinh> danhSach) {
        pnlTuyen.removeAll();
        pnlTuyen.setLayout(new BorderLayout());
        
        // Panel ch·ª©a c√°c card chuy·∫øn t√†u - chi·ªÅu ngang
        JPanel containerPanel = new JPanel();
        containerPanel.setLayout(new FlowLayout(FlowLayout.LEFT, 15, 10));
        containerPanel.setBackground(Color.WHITE);
        
        for (LichTrinh lt : danhSach) {
            JPanel cardChuyenTau = taoCardChuyenTauCompact(lt);
            containerPanel.add(cardChuyenTau);
        }
        
        // Th√™m scroll pane KH√îNG hi·ªÉn th·ªã scrollbar
        JScrollPane scrollPane = new JScrollPane(containerPanel);
        scrollPane.setHorizontalScrollBarPolicy(JScrollPane.HORIZONTAL_SCROLLBAR_NEVER);
        scrollPane.setVerticalScrollBarPolicy(JScrollPane.VERTICAL_SCROLLBAR_NEVER);
        scrollPane.setBorder(null);
        scrollPane.getHorizontalScrollBar().setUnitIncrement(16);
        
        pnlTuyen.add(scrollPane, BorderLayout.CENTER);
        
        pnlTuyen.revalidate();
        pnlTuyen.repaint();
    }
    
    /**
     * T·∫°o card chuy·∫øn t√†u s·ª≠ d·ª•ng TauIteam component
     */
    private JPanel taoCardChuyenTauCompact(LichTrinh lt) {
        // T·∫°o TauIteam component
        compoment.TauIteam tauItem = new compoment.TauIteam();
        
        // Set d·ªØ li·ªáu
        String soHieuTau = lt.getChuyenTau() != null ? lt.getChuyenTau().getSoHieuTau() : "SE1";
        java.time.format.DateTimeFormatter formatter = java.time.format.DateTimeFormatter.ofPattern("dd/MM/yyyy HH:mm");
        String tgDi = lt.getGioKhoiHanh() != null ? lt.getGioKhoiHanh().format(formatter) : "N/A";
        String tgDen = lt.getGioDen() != null ? lt.getGioDen().format(formatter) : "N/A";
        
        tauItem.setData(soHieuTau, tgDi, tgDen);
        
        // Set m√†u theo tr·∫°ng th√°i ch·ªçn
        boolean isSelected = lichTrinhDangChon != null && 
                            lichTrinhDangChon.getMaLichTrinh().equals(lt.getMaLichTrinh());
        tauItem.setSelected(isSelected);
        
        // Click v√†o card ƒë·ªÉ ch·ªçn chuy·∫øn
        tauItem.setCursor(new Cursor(Cursor.HAND_CURSOR));
        tauItem.addMouseListener(new MouseAdapter() {
            @Override
            public void mouseClicked(MouseEvent e) {
                lichTrinhDangChon = lt;
                
                // üîç DEBUG: Log l·ªãch tr√¨nh ƒëang ch·ªçn
                System.out.println("üöÜ Ch·ªçn t√†u: L·ªãch tr√¨nh " + lt.getMaLichTrinh() + 
                    " | Gi·ªù KH: " + (lt.getGioKhoiHanh() != null ? lt.getGioKhoiHanh() : "null"));
                
                // Reload l·∫°i danh s√°ch chuy·∫øn t√†u ƒë·ªÉ c·∫≠p nh·∫≠t m√†u
                if (danhSachLichTrinh != null) {
                    hienThiDanhSachChuyenTauTrongPanel(danhSachLichTrinh);
                }
                
                // Hi·ªÉn th·ªã danh s√°ch toa
                hienThiDanhSachToaTrongPanel(lt);
            }
        });
        
        return tauItem;
    }
    
    /**
     * Hi·ªÉn th·ªã danh s√°ch toa trong panel
     */
    private void hienThiDanhSachToaTrongPanel(LichTrinh lt) {
        pnlToaTau.removeAll();
        pnlToaTau.setVisible(true);
        pnlToaTau.setLayout(new FlowLayout(FlowLayout.LEFT, 3, 5));
        
        if (lt == null || lt.getChuyenTau() == null) {
            return;
        }
        
        // Th√™m icon ƒë·∫ßu t√†u s·ª≠ d·ª•ng TrainHeaderIteam component
        compoment.TrainHeaderIteam trainHeader = new compoment.TrainHeaderIteam();
        pnlToaTau.add(trainHeader);
        
        String soHieuTau = lt.getChuyenTau().getSoHieuTau();
        List<Toa> danhSachToa = toaDAO.getToaBySoHieuTau(soHieuTau);
        
        // T·∫°o 10 toa (5 ng·ªìi m·ªÅm + 5 gi∆∞·ªùng n·∫±m)
        for (int i = 1; i <= 10; i++) {
            // T√¨m toa t∆∞∆°ng ·ª©ng ho·∫∑c t·∫°o toa gi·∫£
            Toa toa = null;
            if (danhSachToa != null) {
                for (Toa t : danhSachToa) {
                    if (t.getSoToa() == i) {
                        toa = t;
                        break;
                    }
                }
            }
            
            // N·∫øu kh√¥ng c√≥ toa trong DB, t·∫°o toa gi·∫£
            if (toa == null) {
                toa = new Toa();
                toa.setSoToa(i);
                if (i <= 5) {
                    LoaiToa loaiToa = new LoaiToa("LTOA001", "Ng·ªìi m·ªÅm ƒëi·ªÅu h√≤a");
                    toa.setLoaiToa(loaiToa);
                } else {
                    LoaiToa loaiToa = new LoaiToa("LTOA002", "Gi∆∞·ªùng n·∫±m khoang 6 ƒëi·ªÅu h√≤a");
                    toa.setLoaiToa(loaiToa);
                }
                toa.setMaToa("FAKE-T" + String.format("%02d", i));
            } else if (i >= 6 && i <= 10) {
                // Fix: N·∫øu toa 6-10 t·ª´ DB c√≥ t√™n sai (VIP, v.v.), override th√†nh "Gi∆∞·ªùng n·∫±m khoang 6 ƒëi·ªÅu h√≤a"
                if (toa.getLoaiToa() != null) {
                    String tenLoai = toa.getLoaiToa().getTenLoaiToa();
                    if (tenLoai == null || !tenLoai.contains("Gi∆∞·ªùng n·∫±m")) {
                        LoaiToa loaiToaMoi = new LoaiToa(toa.getLoaiToa().getMaLoaiToa(), "Gi∆∞·ªùng n·∫±m khoang 6 ƒëi·ªÅu h√≤a");
                        toa.setLoaiToa(loaiToaMoi);
                    }
                }
            }
            
            JPanel panelToa = taoBtnToaVoiIcon(toa, lt, i);
            pnlToaTau.add(panelToa);
            
            // Auto load toa 1 v√† highlight n√≥
            if (i == 1) {
                if (panelToa instanceof compoment.ToaIteam) {
                    ((compoment.ToaIteam) panelToa).setSelected(true);
                }
                toaDangChon = toa;
                
                // T·∫°o bi·∫øn final ƒë·ªÉ d√πng trong lambda
                final Toa toaFinal = toa;
                
                // Delay m·ªôt ch√∫t ƒë·ªÉ UI ƒë√£ render xong
                SwingUtilities.invokeLater(() -> {
                    hienThiSoDoGheTrongPanel(toaFinal, lt);
                });
            }
        }
        
        pnlToaTau.revalidate();
        pnlToaTau.repaint();
    }
    
    /**
     * T·∫°o button toa s·ª≠ d·ª•ng ToaIteam component
     */
    private JPanel taoBtnToaVoiIcon(Toa toa, LichTrinh lt, int soToa) {
        // T·∫°o ToaIteam component
        compoment.ToaIteam toaItem = new compoment.ToaIteam();
        
        // Set s·ªë toa
        toaItem.setSoToa(soToa);
        toaItem.setSelected(false); // M·∫∑c ƒë·ªãnh ch∆∞a ch·ªçn
        toaItem.setCursor(new Cursor(Cursor.HAND_CURSOR));
        
        // Hover effect v√† click event
        toaItem.addMouseListener(new MouseAdapter() {
            @Override
            public void mouseEntered(MouseEvent e) {
                toaItem.setHover(true);
                toaItem.repaint();
            }
            
            @Override
            public void mouseExited(MouseEvent e) {
                toaItem.setHover(false);
                toaItem.repaint();
            }
            
            @Override
            public void mouseClicked(MouseEvent e) {
                // Reset t·∫•t c·∫£ toa v·ªÅ m√†u tr·∫Øng
                Component[] components = pnlToaTau.getComponents();
                for (Component c : components) {
                    if (c instanceof compoment.ToaIteam && c != toaItem) {
                        ((compoment.ToaIteam) c).setSelected(false);
                        c.repaint();
                    }
                }
                
                // Highlight toa ƒë∆∞·ª£c ch·ªçn
                toaItem.setSelected(true);
                toaItem.repaint();
                
                toaDangChon = toa;
                hienThiSoDoGheTrongPanel(toa, lt);
            }
        });
        
        return toaItem;
    }
    
    /**
     * Hi·ªÉn th·ªã s∆° ƒë·ªì gh·∫ø trong panel
     */
    private void hienThiSoDoGheTrongPanel(Toa toa, LichTrinh lt) {
        pnlSoDoGhe.removeAll();
        pnlSoDoGhe.setVisible(true);
        pnlChieuMuaVe.setVisible(true);
        
        if (toa == null || lt == null) {
            return;
        }
        
        // L∆∞u toa ƒëang hi·ªÉn th·ªã ƒë·ªÉ reload sau khi thanh to√°n
        this.toaDangChon = toa;
        
        // S·ª≠ d·ª•ng BorderLayout ƒë·ªÉ th√™m title
        pnlSoDoGhe.setLayout(new BorderLayout(5, 5));
        
        // Panel title
        String tenLoaiToa = toa.getLoaiToa() != null ? toa.getLoaiToa().getTenLoaiToa() : "";
        JLabel lblTitle = new JLabel("Toa s·ªë " + toa.getSoToa() + ": " + tenLoaiToa);
        lblTitle.setFont(new Font("Segoe UI", Font.BOLD, 14));
        lblTitle.setForeground(new Color(0, 102, 204));
        lblTitle.setHorizontalAlignment(SwingConstants.CENTER);
        lblTitle.setBorder(BorderFactory.createEmptyBorder(5, 5, 5, 5));
        pnlSoDoGhe.add(lblTitle, BorderLayout.NORTH);
        
        // Query danh s√°ch ch·ªó ng·ªìi t·ª´ DB
        List<ChoNgoi> danhSachCho = choNgoiDAO.getChoNgoiByMaToa(toa.getMaToa());
        if (danhSachCho == null || danhSachCho.isEmpty()) {
            JLabel lblError = new JLabel("Kh√¥ng c√≥ d·ªØ li·ªáu ch·ªó ng·ªìi cho toa n√†y!");
            lblError.setFont(new Font("Segoe UI", Font.BOLD, 14));
            lblError.setForeground(Color.RED);
            lblError.setHorizontalAlignment(SwingConstants.CENTER);
            pnlSoDoGhe.add(lblError, BorderLayout.CENTER);
            pnlSoDoGhe.revalidate();
            pnlSoDoGhe.repaint();
            return;
        }
        
        // ‚ö° T·ªêI ∆ØU: Query 1 l·∫ßn danh s√°ch gh·∫ø ƒë√£ ƒë·∫∑t cho c·∫£ l·ªãch tr√¨nh
        java.util.Set<String> gheDaDatSet = veDAO.layDanhSachGheDaDat(lt.getMaLichTrinh());
        System.out.println("üìä L·ªãch tr√¨nh " + lt.getMaLichTrinh() + " c√≥ " + gheDaDatSet.size() + " gh·∫ø ƒë√£ b√°n: " + gheDaDatSet);
        
        // Ki·ªÉm tra toa ng·ªìi hay n·∫±m
        int soToa = toa.getSoToa();
        
        if (soToa <= 5) {
            // Toa 1-5: Ng·ªìi m·ªÅm - 64 gh·∫ø (4 g√≥c, m·ªói g√≥c 2 d√£y x 8 gh·∫ø)
            JPanel pnlGheContainer = new JPanel(new BorderLayout(0, 8));
            pnlGheContainer.setBackground(Color.WHITE);
            
            // Panel ph√≠a tr√™n (2 g√≥c tr√™n)
            JPanel pnlTop = new JPanel();
            pnlTop.setLayout(new BoxLayout(pnlTop, BoxLayout.X_AXIS));
            pnlTop.setBackground(Color.WHITE);
            
            // Th√™m glue ƒë·ªÉ cƒÉn gi·ªØa
            pnlTop.add(Box.createHorizontalGlue());
            
            // G√≥c tr√™n tr√°i (2 d√£y x 8 gh·∫ø)
            JPanel gocTrenTrai = taoGocGhe(1, 16, danhSachCho, gheDaDatSet, lt); // Gh·∫ø 1-16
            pnlTop.add(gocTrenTrai);
            
            pnlTop.add(Box.createHorizontalStrut(6));
            
            // Line d·ªçc gi·ªØa (l·ªëi ƒëi)
            JLabel lblLineTop = taoLineDoc();
            pnlTop.add(lblLineTop);
            
            pnlTop.add(Box.createHorizontalStrut(6));
            
            // G√≥c tr√™n ph·∫£i (2 d√£y x 8 gh·∫ø)
            JPanel gocTrenPhai = taoGocGhe(17, 32, danhSachCho, gheDaDatSet, lt); // Gh·∫ø 17-32
            pnlTop.add(gocTrenPhai);
            
            // Th√™m glue ƒë·ªÉ cƒÉn gi·ªØa
            pnlTop.add(Box.createHorizontalGlue());
            
            pnlGheContainer.add(pnlTop, BorderLayout.NORTH);
            
            // Kho·∫£ng tr·∫Øng gi·ªØa (l·ªëi ƒëi ngang)
            JPanel pnlGap = new JPanel();
            pnlGap.setBackground(Color.WHITE);
            pnlGap.setPreferredSize(new Dimension(0, 15));
            pnlGheContainer.add(pnlGap, BorderLayout.CENTER);
            
            // Panel ph√≠a d∆∞·ªõi (2 g√≥c d∆∞·ªõi)
            JPanel pnlBottom = new JPanel();
            pnlBottom.setLayout(new BoxLayout(pnlBottom, BoxLayout.X_AXIS));
            pnlBottom.setBackground(Color.WHITE);
            
            // Th√™m glue ƒë·ªÉ cƒÉn gi·ªØa
            pnlBottom.add(Box.createHorizontalGlue());
            
            // G√≥c d∆∞·ªõi tr√°i (2 d√£y x 8 gh·∫ø)
            JPanel gocDuoiTrai = taoGocGhe(33, 48, danhSachCho, gheDaDatSet, lt); // Gh·∫ø 33-48
            pnlBottom.add(gocDuoiTrai);
            
            pnlBottom.add(Box.createHorizontalStrut(6));
            
            // Line d·ªçc gi·ªØa (l·ªëi ƒëi)
            JLabel lblLineBottom = taoLineDoc();
            pnlBottom.add(lblLineBottom);
            
            pnlBottom.add(Box.createHorizontalStrut(6));
            
            // G√≥c d∆∞·ªõi ph·∫£i (2 d√£y x 8 gh·∫ø)
            JPanel gocDuoiPhai = taoGocGhe(49, 64, danhSachCho, gheDaDatSet, lt); // Gh·∫ø 49-64
            pnlBottom.add(gocDuoiPhai);
            
            // Th√™m glue ƒë·ªÉ cƒÉn gi·ªØa
            pnlBottom.add(Box.createHorizontalGlue());
            
            pnlGheContainer.add(pnlBottom, BorderLayout.SOUTH);
            
            pnlSoDoGhe.add(pnlGheContainer, BorderLayout.CENTER);
        } else {
            // Toa 6-10: Gi∆∞·ªùng n·∫±m - 7 khoang x 6 gi∆∞·ªùng
            
            // Panel wrapper v·ªõi vertical box ƒë·ªÉ chi·∫øm ƒë·ªß kh√¥ng gian
            JPanel wrapperPanel = new JPanel();
            wrapperPanel.setLayout(new BoxLayout(wrapperPanel, BoxLayout.Y_AXIS));
            wrapperPanel.setBackground(Color.WHITE);
            
            // Th√™m vertical glue ph√≠a tr√™n
            wrapperPanel.add(Box.createVerticalGlue());
            
            JPanel pnlKhoangContainer = new JPanel();
            pnlKhoangContainer.setLayout(new BoxLayout(pnlKhoangContainer, BoxLayout.X_AXIS));
            pnlKhoangContainer.setBackground(Color.WHITE);
            
            // Th√™m glue ƒë·ªÉ cƒÉn gi·ªØa
            pnlKhoangContainer.add(Box.createHorizontalGlue());
            
            int viTriGhe = 1;
            for (int k = 1; k <= 7; k++) {
                // M·ªói khoang
                JPanel khoang = new JPanel();
                khoang.setLayout(new BorderLayout(5, 5));
                khoang.setBorder(BorderFactory.createTitledBorder(
                    BorderFactory.createLineBorder(new Color(100, 100, 100), 2), 
                    "Khoang " + k,
                    javax.swing.border.TitledBorder.CENTER,
                    javax.swing.border.TitledBorder.TOP,
                    new Font("Segoe UI", Font.BOLD, 11)
                ));
                khoang.setBackground(Color.WHITE);
                khoang.setPreferredSize(new Dimension(130, 210)); // C·ªë ƒë·ªãnh k√≠ch th∆∞·ªõc
                khoang.setMaximumSize(new Dimension(130, 210));
                
                // 6 gi∆∞·ªùng trong khoang (3 h√†ng x 2 c·ªôt - 3 t·∫ßng m·ªói b√™n)
                JPanel pnlGiuong = new JPanel(new GridLayout(3, 2, 4, 4));
                pnlGiuong.setBackground(Color.WHITE);
                pnlGiuong.setBorder(BorderFactory.createEmptyBorder(8, 8, 8, 8));
                
                for (int i = 0; i < 6; i++) {
                    final int viTriHienTai = viTriGhe;
                    
                    // T√¨m ChoNgoi t∆∞∆°ng ·ª©ng v·ªõi v·ªã tr√≠ n√†y
                    ChoNgoi choNgoi = null;
                    for (ChoNgoi cho : danhSachCho) {
                        if (cho.getViTri() == viTriHienTai) {
                            choNgoi = cho;
                            break;
                        }
                    }
                    
                    if (choNgoi == null) {
                        // Kh√¥ng t√¨m th·∫•y ch·ªó ng·ªìi => hi·ªÉn th·ªã panel tr·ªëng
                        JPanel emptyPanel = new JPanel();
                        emptyPanel.setBackground(Color.WHITE);
                        pnlGiuong.add(emptyPanel);
                        viTriGhe++;
                        continue;
                    }
                    
                    final ChoNgoi choFinal = choNgoi; // For lambda
                    
                    // ‚ö° T·ªêI ∆ØU: Check trong Set thay v√¨ query DB
                    boolean daDat = gheDaDatSet.contains(choNgoi.getMaChoNgoi());
                    
                    JButton btnGhe = new JButton(String.valueOf(viTriHienTai));
                    btnGhe.setPreferredSize(new Dimension(52, 48));
                    btnGhe.setFont(new Font("Segoe UI", Font.BOLD, 12));
                    btnGhe.setFocusPainted(false);
                    btnGhe.setCursor(new Cursor(Cursor.HAND_CURSOR));
                    
                    // Set m√†u d·ª±a tr√™n tr·∫°ng th√°i
                    if (daDat) {
                        // Gh·∫ø ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t => m√†u ƒë·ªè ƒë·∫≠m full, kh√¥ng cho click
                        btnGhe.setBackground(new Color(220, 53, 69));
                        btnGhe.setForeground(Color.WHITE);
                        btnGhe.setEnabled(false);
                        btnGhe.setBorder(BorderFactory.createLineBorder(new Color(180, 40, 55), 2));
                    } else if (QuanLyGheGiuCho.kiemTraGheDangGiuCho(choNgoi.getMaChoNgoi(), lt.getMaLichTrinh())) {
                        // Gh·∫ø ƒëang ƒë∆∞·ª£c gi·ªØ ch·ªó (15 ph√∫t) => m√†u v√†ng ƒë·∫≠m full, kh√¥ng cho click
                        btnGhe.setBackground(new Color(255, 193, 7));
                        btnGhe.setForeground(Color.WHITE);
                        btnGhe.setEnabled(false);
                        btnGhe.setBorder(BorderFactory.createLineBorder(new Color(220, 165, 0), 2));
                        btnGhe.setToolTipText("Gh·∫ø ƒëang ƒë∆∞·ª£c gi·ªØ ch·ªó (15 ph√∫t)");
                    } else if (kiemTraGheDangDuocChon(choFinal)) {
                        // Gh·∫ø ƒëang ƒë∆∞·ª£c ch·ªçn => m√†u xanh ƒë·∫≠m full
                        btnGhe.setBackground(new Color(0, 120, 215));
                        btnGhe.setForeground(Color.WHITE);
                        btnGhe.setBorder(BorderFactory.createLineBorder(new Color(0, 100, 180), 2));
                        
                        // Click ƒë·ªÉ b·ªè ch·ªçn
                        btnGhe.addActionListener(e -> {
                            xuLyChonGhe(choFinal, lt, btnGhe);
                        });
                    } else {
                        // Gh·∫ø c√≤n tr·ªëng => m√†u tr·∫Øng, cho ph√©p click
                        btnGhe.setBackground(Color.WHITE);
                        btnGhe.setBorder(BorderFactory.createLineBorder(Color.GRAY, 1));
                        
                        // Click ƒë·ªÉ ch·ªçn/b·ªè ch·ªçn gh·∫ø
                        btnGhe.addActionListener(e -> {
                            xuLyChonGhe(choFinal, lt, btnGhe);
                        });
                    }
                    
                    pnlGiuong.add(btnGhe);
                    viTriGhe++;
                }
                
                khoang.add(pnlGiuong, BorderLayout.CENTER);
                pnlKhoangContainer.add(khoang);
                
                // Th√™m line ngƒÉn c√°ch gi·ªØa c√°c khoang (tr·ª´ khoang cu·ªëi)
                if (k < 7) {
                    JLabel line = new JLabel();
                    try {
                        ImageIcon lineIcon = new ImageIcon(getClass().getResource("/icon/line.jpg"));
                        Image img = lineIcon.getImage().getScaledInstance(6, 210, Image.SCALE_SMOOTH);
                        line.setIcon(new ImageIcon(img));
                    } catch (Exception e) {
                        // Fallback: d√πng panel m√†u x√°m
                        line.setText("");
                        line.setOpaque(true);
                        line.setBackground(new Color(100, 100, 100));
                        line.setPreferredSize(new Dimension(6, 210));
                    }
                    pnlKhoangContainer.add(line);
                }
            }
            
            // Th√™m glue ƒë·ªÉ cƒÉn gi·ªØa
            pnlKhoangContainer.add(Box.createHorizontalGlue());
            
            wrapperPanel.add(pnlKhoangContainer);
            
            // Th√™m vertical glue ph√≠a d∆∞·ªõi
            wrapperPanel.add(Box.createVerticalGlue());
            
            pnlSoDoGhe.add(wrapperPanel, BorderLayout.CENTER);
        }
        
        pnlSoDoGhe.revalidate();
        pnlSoDoGhe.repaint();
    }
    
    /**
     * T·∫°o 1 g√≥c gh·∫ø (2 d√£y x 8 gh·∫ø n·∫±m ngang) - T·ªêI ∆ØU
     */
    private JPanel taoGocGhe(int gheStart, int gheEnd, List<ChoNgoi> danhSachCho, java.util.Set<String> gheDaDatSet, LichTrinh lt) {
        JPanel goc = new JPanel(new GridLayout(2, 8, 3, 3)); // 2 d√£y, 8 gh·∫ø m·ªói d√£y
        goc.setBackground(Color.WHITE);
        
        for (int viTri = gheStart; viTri <= gheEnd; viTri++) {
            // T√¨m ChoNgoi t∆∞∆°ng ·ª©ng v·ªõi v·ªã tr√≠ n√†y
            ChoNgoi choNgoi = null;
            for (ChoNgoi cho : danhSachCho) {
                if (cho.getViTri() == viTri) {
                    choNgoi = cho;
                    break;
                }
            }
            
            if (choNgoi == null) {
                // Kh√¥ng t√¨m th·∫•y ch·ªó ng·ªìi => hi·ªÉn th·ªã panel tr·ªëng
                JPanel emptyPanel = new JPanel();
                emptyPanel.setBackground(Color.WHITE);
                goc.add(emptyPanel);
                continue;
            }
            
            // T·∫°o button gh·∫ø v·ªõi d·ªØ li·ªáu th·ª±c
            final ChoNgoi choFinal = choNgoi; // For lambda
            
            // ‚ö° T·ªêI ∆ØU: Check trong Set thay v√¨ query DB
            boolean daDat = gheDaDatSet.contains(choNgoi.getMaChoNgoi());
            
            JButton btnGhe = new JButton(String.valueOf(viTri));
            btnGhe.setPreferredSize(new Dimension(46, 38));
            btnGhe.setFont(new Font("Segoe UI", Font.BOLD, 11));
            btnGhe.setFocusPainted(false);
            btnGhe.setCursor(new Cursor(Cursor.HAND_CURSOR));
            
            // Set m√†u d·ª±a tr√™n tr·∫°ng th√°i
            if (daDat) {
                // Gh·∫ø ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t => m√†u ƒë·ªè ƒë·∫≠m full, kh√¥ng cho click
                btnGhe.setBackground(new Color(220, 53, 69));
                btnGhe.setForeground(Color.WHITE);
                btnGhe.setEnabled(false);
                btnGhe.setBorder(BorderFactory.createLineBorder(new Color(180, 40, 55), 2));
            } else if (QuanLyGheGiuCho.kiemTraGheDangGiuCho(choNgoi.getMaChoNgoi(), lt.getMaLichTrinh())) {
                // Gh·∫ø ƒëang ƒë∆∞·ª£c gi·ªØ ch·ªó (5 ph√∫t) => m√†u v√†ng ƒë·∫≠m full, kh√¥ng cho click
                btnGhe.setBackground(new Color(255, 193, 7));
                btnGhe.setForeground(Color.WHITE);
                btnGhe.setEnabled(false);
                btnGhe.setBorder(BorderFactory.createLineBorder(new Color(220, 165, 0), 2));
                btnGhe.setToolTipText("Gh·∫ø ƒëang ƒë∆∞·ª£c gi·ªØ ch·ªó (5 ph√∫t)");
            } else if (kiemTraGheDangDuocChon(choFinal)) {
                // Gh·∫ø ƒëang ƒë∆∞·ª£c ch·ªçn => m√†u xanh ƒë·∫≠m full
                btnGhe.setBackground(new Color(0, 120, 215));
                btnGhe.setForeground(Color.WHITE);
                btnGhe.setBorder(BorderFactory.createLineBorder(new Color(0, 100, 180), 2));
                
                // Click ƒë·ªÉ b·ªè ch·ªçn
                btnGhe.addActionListener(e -> {
                    xuLyChonGhe(choFinal, lt, btnGhe);
                });
            } else {
                // Gh·∫ø c√≤n tr·ªëng => m√†u tr·∫Øng, cho ph√©p click
                btnGhe.setBackground(Color.WHITE);
                btnGhe.setBorder(BorderFactory.createLineBorder(Color.GRAY, 1));
                
                // Click ƒë·ªÉ ch·ªçn/b·ªè ch·ªçn gh·∫ø
                btnGhe.addActionListener(e -> {
                    xuLyChonGhe(choFinal, lt, btnGhe);
                });
            }
            
            goc.add(btnGhe);
        }
        
        return goc;
    }
    
    /**
     * T·∫°o line d·ªçc (l·ªëi ƒëi)
     */
    private JLabel taoLineDoc() {
        JLabel line = new JLabel();
        try {
            ImageIcon lineIcon = new ImageIcon(getClass().getResource("/icon/line.jpg"));
            Image img = lineIcon.getImage().getScaledInstance(6, 88, Image.SCALE_SMOOTH);
            line.setIcon(new ImageIcon(img));
        } catch (Exception e) {
            // Fallback: d√πng panel m√†u x√°m
            line.setText("");
            line.setOpaque(true);
            line.setBackground(new Color(150, 150, 150));
            line.setPreferredSize(new Dimension(6, 88));
        }
        return line;
    }
    
    /**
     * T·∫°o button gh·∫ø compact
     */
    private JButton taoBtnGheCompact(ChoNgoi cho, LichTrinh lt) {
        JButton btn = new JButton(String.valueOf(cho.getViTri()));
        btn.setPreferredSize(new Dimension(40, 40));
        btn.setFont(new Font("Segoe UI", Font.BOLD, 10));
        btn.setFocusPainted(false);
        btn.setCursor(new Cursor(Cursor.HAND_CURSOR));
        
        // Ki·ªÉm tra tr·∫°ng th√°i gh·∫ø
        boolean daDat = choNgoiDAO.kiemTraChoNgoiDaDat(cho.getMaChoNgoi(), lt.getMaLichTrinh());
        boolean dangGiuCho = QuanLyGheGiuCho.kiemTraGheDangGiuCho(cho.getMaChoNgoi(), lt.getMaLichTrinh());
        boolean dangChon = kiemTraGheDangDuocChon(cho);
        
        if (daDat) {
            // Gh·∫ø ƒë√£ ƒë·∫∑t - m√†u ƒë·ªè ƒë·∫≠m full, disable
            btn.setBackground(new Color(220, 53, 69));
            btn.setForeground(Color.WHITE);
            btn.setEnabled(false);
            btn.setBorder(BorderFactory.createLineBorder(new Color(180, 40, 55), 2));
        } else if (dangGiuCho) {
            // Gh·∫ø ƒëang ƒë∆∞·ª£c gi·ªØ ch·ªó (15 ph√∫t) - m√†u v√†ng ƒë·∫≠m full, disable
            btn.setBackground(new Color(255, 193, 7));
            btn.setForeground(Color.WHITE);
            btn.setEnabled(false);
            btn.setBorder(BorderFactory.createLineBorder(new Color(220, 165, 0), 2));
            btn.setToolTipText("Gh·∫ø ƒëang ƒë∆∞·ª£c gi·ªØ ch·ªó (15 ph√∫t)");
        } else if (dangChon) {
            // Gh·∫ø ƒëang ch·ªçn - m√†u xanh ƒë·∫≠m full
            btn.setBackground(new Color(0, 120, 215));
            btn.setForeground(Color.WHITE);
            btn.setBorder(BorderFactory.createLineBorder(new Color(0, 100, 180), 2));
        } else {
            // Gh·∫ø tr·ªëng - m√†u tr·∫Øng
            btn.setBackground(Color.WHITE);
            btn.setForeground(Color.BLACK);
            btn.setBorder(BorderFactory.createLineBorder(Color.GRAY, 1));
        }
        
        btn.addActionListener(e -> {
            xuLyChonGhe(cho, lt, btn);
        });
        
        return btn;
    }
    
    /**
     * Ki·ªÉm tra gh·∫ø ƒë√£ ƒë∆∞·ª£c ch·ªçn ch∆∞a (so s√°nh theo MaChoNgoi)
     */
    private boolean kiemTraGheDangDuocChon(ChoNgoi cho) {
        for (ChoNgoi choChon : danhSachGheDangChon) {
            if (choChon.getMaChoNgoi().equals(cho.getMaChoNgoi())) {
                return true;
            }
        }
        return false;
    }
    
    /**
     * L·∫•y gh·∫ø ƒë√£ ch·ªçn theo MaChoNgoi
     */
    private ChoNgoi layGheDangChon(ChoNgoi cho) {
        for (ChoNgoi choChon : danhSachGheDangChon) {
            if (choChon.getMaChoNgoi().equals(cho.getMaChoNgoi())) {
                return choChon;
            }
        }
        return null;
    }
    
    /**
     * X·ª≠ l√Ω khi ch·ªçn/b·ªè ch·ªçn gh·∫ø
     */
    private void xuLyChonGhe(ChoNgoi cho, LichTrinh lt, JButton btn) {
        // Ki·ªÉm tra gh·∫ø ƒë√£ ƒë∆∞·ª£c ch·ªçn ch∆∞a (so s√°nh theo MaChoNgoi)
        ChoNgoi gheDaChon = layGheDangChon(cho);
        
        if (gheDaChon != null) {
            // B·ªè ch·ªçn gh·∫ø
            danhSachGheDangChon.remove(gheDaChon);
            btn.setBackground(Color.WHITE);
            btn.setBorder(BorderFactory.createLineBorder(Color.GRAY, 1));
            
            // X√≥a kh·ªèi gi·ªè v√©
            xoaKhoiGioVe(gheDaChon);
        } else {
            // Ch·ªçn gh·∫ø
            danhSachGheDangChon.add(cho);
            btn.setBackground(new Color(153, 204, 255));
            btn.setBorder(BorderFactory.createLineBorder(Color.BLUE, 2));
            
            // Th√™m v√†o gi·ªè v√©
            themVaoGioVe(cho, lt);
        }
    }
    
    /**
     * Th√™m v√© v√†o gi·ªè
     */
    private void themVaoGioVe(ChoNgoi cho, LichTrinh lt) {
        // Format: SE1 | S√†i G√≤n - H√† N·ªôi
        String soHieuTau = lt.getChuyenTau() != null ? lt.getChuyenTau().getSoHieuTau() : "N/A";
        String tuyen = soHieuTau + " | " + lt.getGaDi().getTenGa() + " - " + lt.getGaDen().getTenGa();
        String choNgoi = "Toa " + cho.getToa().getSoToa() + " - Gh·∫ø " + cho.getViTri();
        String chieu = radChieuDi.isSelected() ? "Chi·ªÅu ƒëi" : "Chi·ªÅu v·ªÅ";
        
        // üîç DEBUG: Log l·ªãch tr√¨nh ƒë∆∞·ª£c th√™m v√†o gi·ªè
        System.out.println("‚ûï Th√™m v√†o gi·ªè: Gh·∫ø " + cho.getMaChoNgoi() + " | L·ªãch tr√¨nh " + lt.getMaLichTrinh() + 
            " | Gi·ªù KH: " + (lt.getGioKhoiHanh() != null ? lt.getGioKhoiHanh() : "null"));
        
        // L∆∞u l·ªãch tr√¨nh c·ªßa gh·∫ø n√†y v√†o map
        mapGheLichTrinh.put(cho, lt);
        
        // Th√™m v√†o b·∫£ng: Tuy·∫øn | Ch·ªó ng·ªìi | Chi·ªÅu (gi·ªØ nguy√™n 3 c·ªôt nh∆∞ giao di·ªán c≈©)
        modelGioVe.addRow(new Object[]{tuyen, choNgoi, chieu});
    }
    
    /**
     * X√≥a v√© kh·ªèi gi·ªè d·ª±a v√†o ch·ªó ng·ªìi
     */
    private void xoaKhoiGioVe(ChoNgoi cho) {
        // X√≥a kh·ªèi map l∆∞u l·ªãch tr√¨nh
        mapGheLichTrinh.remove(cho);
        
        for (int i = 0; i < modelGioVe.getRowCount(); i++) {
            String choNgoi = (String) modelGioVe.getValueAt(i, 1); // C·ªôt th·ª© 2: Ch·ªó ng·ªìi
            String gheCurrent = "Toa " + cho.getToa().getSoToa() + " - Gh·∫ø " + cho.getViTri();
            
            if (choNgoi.equals(gheCurrent)) {
                modelGioVe.removeRow(i);
                break;
            }
        }
    }
    
    // ===================== CHI·ªÄU MUA V√â =====================
    
    /**
     * Chuy·ªÉn sang chi·ªÅu v·ªÅ (swap ga ƒëi/ƒë·∫øn)
     */
    private void chuyenChieuVe() {
        System.out.println("üîÑ ========== CHUY·ªÇN CHI·ªÄU V·ªÄ ==========");
        System.out.println("üìç gaDiGoc = " + gaDiGoc);
        System.out.println("üìç gaDenGoc = " + gaDenGoc);
        System.out.println("üìç ngayDiGoc = " + ngayDiGoc);
        System.out.println("üìç ngayVeGoc = " + ngayVeGoc);
        
        // Ki·ªÉm tra xem ƒë√£ t√¨m ki·∫øm chi·ªÅu ƒëi ch∆∞a
        if (gaDiGoc == null || gaDenGoc == null) {
            JOptionPane.showMessageDialog(this,
                "Vui l√≤ng t√¨m ki·∫øm chi·ªÅu ƒëi tr∆∞·ªõc!",
                "Th√¥ng b√°o", JOptionPane.WARNING_MESSAGE);
            radChieuDi.setSelected(true);
            return;
        }
        
        // Ki·ªÉm tra xem c√≥ ch·ªçn kh·ª© h·ªìi kh√¥ng
        if (radMotChieu.isSelected()) {
            JOptionPane.showMessageDialog(this,
                "Vui l√≤ng ch·ªçn 'Kh·ª© h·ªìi' ƒë·ªÉ mua v√© chi·ªÅu v·ªÅ!",
                "Th√¥ng b√°o", JOptionPane.WARNING_MESSAGE);
            radChieuDi.setSelected(true);
            return;
        }
        
        // Ki·ªÉm tra c√≥ ng√†y v·ªÅ kh√¥ng
        if (ngayVeGoc == null) {
            JOptionPane.showMessageDialog(this,
                "Vui l√≤ng ch·ªçn ng√†y v·ªÅ!",
                "Th√¥ng b√°o", JOptionPane.WARNING_MESSAGE);
            radChieuDi.setSelected(true);
            return;
        }
        
        // Swap ga ƒëi/ƒë·∫øn
        txtGaDi.setText(gaDenGoc);
        txtGaDen.setText(gaDiGoc);
        dchNgayDi.setDate(ngayVeGoc);
        dchNgayVe.setDate(null); // ‚ö° Clear ng√†y v·ªÅ v√¨ chi·ªÅu v·ªÅ l√† v√© m·ªôt chi·ªÅu
        
        System.out.println("‚úÖ ƒê√É SET UI:");
        System.out.println("   - Ga ƒëi: " + gaDenGoc);
        System.out.println("   - Ga ƒë·∫øn: " + gaDiGoc);
        System.out.println("   - Ng√†y ƒëi: " + ngayVeGoc);
        System.out.println("   - Ng√†y v·ªÅ: null");
        
        // Ch·ªâ clear danh s√°ch gh·∫ø ƒëang ch·ªçn (ch∆∞a th√™m v√†o gi·ªè)
        // KH√îNG clear gi·ªè v√© (ƒë·ªÉ gi·ªØ v√© chi·ªÅu ƒëi)
        danhSachGheDangChon.clear();
        
        // T√¨m ki·∫øm chuy·∫øn t√†u chi·ªÅu v·ªÅ
        btnTimKiemActionPerformed(null);
        
        // Highlight l·∫°i c√°c gh·∫ø ƒë√£ c√≥ trong gi·ªè v√© (c·ªßa chi·ªÅu v·ªÅ)
        SwingUtilities.invokeLater(() -> highlightGheDaCoTrongGioVe());
    }
    
    /**
     * Chuy·ªÉn v·ªÅ chi·ªÅu ƒëi (restore l·∫°i ga g·ªëc)
     */
    private void chuyenChieuDi() {
        System.out.println("üîÑ ========== CHUY·ªÇN V·ªÄ CHI·ªÄU ƒêI ==========");
        
        // N·∫øu ch∆∞a c√≥ th√¥ng tin g·ªëc th√¨ kh√¥ng l√†m g√¨
        if (gaDiGoc == null || gaDenGoc == null) {
            System.out.println("‚ö†Ô∏è Ch∆∞a c√≥ th√¥ng tin g·ªëc!");
            return;
        }
        
        // Restore l·∫°i ga ƒëi/ƒë·∫øn g·ªëc
        txtGaDi.setText(gaDiGoc);
        txtGaDen.setText(gaDenGoc);
        dchNgayDi.setDate(ngayDiGoc);
        dchNgayVe.setDate(ngayVeGoc); // ‚ö° Restore l·∫°i ng√†y v·ªÅ
        
        System.out.println("‚úÖ ƒê√É RESTORE UI:");
        System.out.println("   - Ga ƒëi: " + gaDiGoc);
        System.out.println("   - Ga ƒë·∫øn: " + gaDenGoc);
        System.out.println("   - Ng√†y ƒëi: " + ngayDiGoc);
        System.out.println("   - Ng√†y v·ªÅ: " + ngayVeGoc);
        
        // Ch·ªâ clear danh s√°ch gh·∫ø ƒëang ch·ªçn (ch∆∞a th√™m v√†o gi·ªè)
        // KH√îNG clear gi·ªè v√© (ƒë·ªÉ gi·ªØ v√© chi·ªÅu v·ªÅ)
        danhSachGheDangChon.clear();
        
        // T√¨m ki·∫øm l·∫°i chuy·∫øn t√†u chi·ªÅu ƒëi
        btnTimKiemActionPerformed(null);
        
        // Highlight l·∫°i c√°c gh·∫ø ƒë√£ c√≥ trong gi·ªè v√© (c·ªßa chi·ªÅu ƒëi)
        SwingUtilities.invokeLater(() -> highlightGheDaCoTrongGioVe());
    }
    
    /**
     * Highlight l·∫°i c√°c gh·∫ø ƒë√£ c√≥ trong gi·ªè v√© cho l·ªãch tr√¨nh hi·ªán t·∫°i
     */
    private void highlightGheDaCoTrongGioVe() {
        if (lichTrinhDangChon == null) {
            return;
        }
        
        // L·∫•y ga ƒëi/ƒë·∫øn c·ªßa l·ªãch tr√¨nh hi·ªán t·∫°i ƒë·ªÉ so s√°nh
        String gaDiHienTai = txtGaDi.getText().trim();
        String gaDenHienTai = txtGaDen.getText().trim();
        
        // Duy·ªát qua gi·ªè v√©
        for (int i = 0; i < modelGioVe.getRowCount(); i++) {
            // C·ªôt 0: "Tuy·∫øn" (format: "H√† N·ªôi ‚Üí S√†i G√≤n")
            // C·ªôt 1: "Ch·ªó ng·ªìi" (format: "Toa 1 - Gh·∫ø 1A" ho·∫∑c "Toa 6 - Gi∆∞·ªùng 1")
            // C·ªôt 2: "Chi·ªÅu"
            
            String tuyen = modelGioVe.getValueAt(i, 0).toString();
            String choNgoi = modelGioVe.getValueAt(i, 1).toString();
            
            // Parse tuy·∫øn ƒë·ªÉ l·∫•y ga ƒëi/ƒë·∫øn
            // Format: "SE1 | H√† N·ªôi - S√†i G√≤n" ho·∫∑c "H√† N·ªôi ‚Üí S√†i G√≤n"
            String gaDiTrongGio = null;
            String gaDenTrongGio = null;
            
            if (tuyen.contains(" | ")) {
                // Format: "SE1 | H√† N·ªôi - S√†i G√≤n"
                String[] parts1 = tuyen.split(" \\| ");
                if (parts1.length == 2) {
                    String[] parts2 = parts1[1].split(" - ");
                    if (parts2.length == 2) {
                        gaDiTrongGio = parts2[0].trim();
                        gaDenTrongGio = parts2[1].trim();
                    }
                }
            } else if (tuyen.contains(" ‚Üí ")) {
                // Format: "H√† N·ªôi ‚Üí S√†i G√≤n"
                String[] parts = tuyen.split(" ‚Üí ");
                if (parts.length == 2) {
                    gaDiTrongGio = parts[0].trim();
                    gaDenTrongGio = parts[1].trim();
                }
            }
            
            if (gaDiTrongGio == null || gaDenTrongGio == null) {
                continue;
            }
            
            // Ch·ªâ highlight gh·∫ø thu·ªôc l·ªãch tr√¨nh hi·ªán t·∫°i (c√πng chi·ªÅu)
            if (!gaDiTrongGio.equals(gaDiHienTai) || !gaDenTrongGio.equals(gaDenHienTai)) {
                continue; // Kh√¥ng c√πng chi·ªÅu, b·ªè qua
            }
            
            // Parse "Ch·ªó ng·ªìi" ƒë·ªÉ l·∫•y maToa v√† viTri
            // Format: "Toa X - Gh·∫ø Y" ho·∫∑c "Toa X - Gi∆∞·ªùng Y"
            try {
                String[] parts = choNgoi.split(" - ");
                if (parts.length == 2) {
                    String soToa = parts[0].replace("Toa ", "").trim();
                    String viTri = parts[1].replace("Gh·∫ø ", "").replace("Gi∆∞·ªùng ", "").trim();
                    
                    // T√¨m maToa t·ª´ soToa
                    String maToa = null;
                    if (lichTrinhDangChon.getChuyenTau() != null) {
                        List<Toa> danhSachToa = toaDAO.getToaBySoHieuTau(lichTrinhDangChon.getChuyenTau().getSoHieuTau());
                        for (Toa toa : danhSachToa) {
                            if (String.valueOf(toa.getSoToa()).equals(soToa)) {
                                maToa = toa.getMaToa();
                                break;
                            }
                        }
                    }
                    
                    if (maToa != null) {
                        // Query ChoNgoi t·ª´ DB
                        List<ChoNgoi> danhSachCho = choNgoiDAO.getChoNgoiByMaToa(maToa);
                        for (ChoNgoi cn : danhSachCho) {
                            if (String.valueOf(cn.getViTri()).equals(viTri)) {
                                // Th√™m v√†o danh s√°ch gh·∫ø ƒëang ch·ªçn
                                if (!danhSachGheDangChon.contains(cn)) {
                                    danhSachGheDangChon.add(cn);
                                }
                                break;
                            }
                        }
                    }
                }
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
        
        // N·∫øu c√≥ gh·∫ø ƒë∆∞·ª£c th√™m v√†o, t·ª± ƒë·ªông hi·ªÉn th·ªã toa ƒë·∫ßu ti√™n
        if (!danhSachGheDangChon.isEmpty() && lichTrinhDangChon.getChuyenTau() != null) {
            ChoNgoi gheFirst = danhSachGheDangChon.get(0);
            if (gheFirst.getToa() != null) {
                hienThiSoDoGheTrongPanel(gheFirst.getToa(), lichTrinhDangChon);
            }
        }
    }
    
    // ===================== GETTER METHODS =====================
    
    /**
     * L·∫•y danh s√°ch gh·∫ø ƒëang ch·ªçn (chi·ªÅu hi·ªán t·∫°i)
     */
    public List<ChoNgoi> getDanhSachGheDangChon() {
        return danhSachGheDangChon;
    }
    
    /**
     * L·∫•y T·∫§T C·∫¢ v√© trong gi·ªè (c·∫£ chi·ªÅu ƒëi + chi·ªÅu v·ªÅ) v·ªõi th√¥ng tin ƒë·∫ßy ƒë·ªß
     * @return Map<ChoNgoi, LichTrinh> - Gh·∫ø v√† l·ªãch tr√¨nh t∆∞∆°ng ·ª©ng
     */
    public Map<ChoNgoi, LichTrinh> getAllVeTrongGioVe() {
        // ‚ö° T·ªêI ∆ØU: Tr·∫£ v·ªÅ tr·ª±c ti·∫øp map ƒë√£ l∆∞u, kh√¥ng c·∫ßn parse v√† query l·∫°i database
        return new java.util.LinkedHashMap<>(mapGheLichTrinh);
    }
    
    /**
     * L·∫•y l·ªãch tr√¨nh ƒëang ch·ªçn
     */
    public LichTrinh getLichTrinhDangChon() {
        return lichTrinhDangChon;
    }
    
    /**
     * Reload s∆° ƒë·ªì gh·∫ø sau khi thanh to√°n (ƒë·ªÉ c·∫≠p nh·∫≠t gh·∫ø ƒë√£ b√°n)
     */
    public void reloadSoDoGhe() {
        if (lichTrinhDangChon == null || toaDangChon == null) {
            return;
        }
        
        // Clear gi·ªè v√© v√† danh s√°ch gh·∫ø ƒëang ch·ªçn (v√¨ ƒë√£ thanh to√°n xong)
        modelGioVe.setRowCount(0);
        danhSachGheDangChon.clear();
        mapGheLichTrinh.clear(); // Clear map l∆∞u l·ªãch tr√¨nh
        
        // Reload s∆° ƒë·ªì gh·∫ø c·ªßa toa ƒëang hi·ªÉn th·ªã
        hienThiSoDoGheTrongPanel(toaDangChon, lichTrinhDangChon);
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnHuyCho;
    private javax.swing.JButton btnHuyTatCa;
    private javax.swing.JButton btnMuaVe;
    private javax.swing.JButton btnTimKiem;
    private javax.swing.JButton btnXuLyDonTam;
    private com.toedter.calendar.JDateChooser dchNgayDi;
    private com.toedter.calendar.JDateChooser dchNgayVe;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JLabel jLabel7;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel7;
    private javax.swing.JPanel jPanel8;
    private javax.swing.JPanel jPanel9;
    private javax.swing.JLabel lblGaDen;
    private javax.swing.JLabel lblGaDi;
    private javax.swing.JLabel lblNgayDi;
    private javax.swing.JLabel lblNgayVe;
    private javax.swing.JPanel pnlChieuMuaVe;
    private javax.swing.JPanel pnlGioVe;
    private javax.swing.JPanel pnlSoDoGhe;
    private javax.swing.JPanel pnlThongTinHanhTrinh;
    private javax.swing.JPanel pnlToaTau;
    private javax.swing.JPanel pnlTuyen;
    private javax.swing.JRadioButton radChieuDi;
    private javax.swing.JRadioButton radChieuVe;
    private javax.swing.JRadioButton radKhuHoi;
    private javax.swing.JRadioButton radMotChieu;
    private javax.swing.JScrollPane scrGioVe;
    private javax.swing.JTable tblGioVe;
    private javax.swing.JTextField txtGaDen;
    private javax.swing.JTextField txtGaDi;
    // End of variables declaration//GEN-END:variables
    
    //=========================================================================
    // PUBLIC METHODS FOR SYNC WITH Gui_NhapThongTinBanVe
    //=========================================================================
    
    /**
     * X√≥a 1 gh·∫ø ƒë√£ ch·ªçn theo index (g·ªçi t·ª´ Gui_NhapThongTinBanVe)
     * @param index Index c·ªßa gh·∫ø trong danh s√°ch
     */
    public void xoaGheDaChon(int index) {
        if (index < 0 || index >= danhSachGheDangChon.size()) {
            return;
        }
        
        // X√≥a kh·ªèi danh s√°ch
        danhSachGheDangChon.remove(index);
        
        // X√≥a kh·ªèi table gi·ªè v√©
        if (index < modelGioVe.getRowCount()) {
            modelGioVe.removeRow(index);
        }
        
        // RELOAD s∆° ƒë·ªì gh·∫ø ƒë·ªÉ c·∫≠p nh·∫≠t UI (button ƒë·ªïi m√†u)
        if (toaDangChon != null && lichTrinhDangChon != null) {
            hienThiSoDoGheTrongPanel(toaDangChon, lichTrinhDangChon);
        }
    }
    
    /**
     * X√≥a t·∫•t c·∫£ gh·∫ø ƒë√£ ch·ªçn (g·ªçi t·ª´ Gui_NhapThongTinBanVe)
     */
    public void xoaTatCaGheDaChon() {
        // Clear danh s√°ch
        danhSachGheDangChon.clear();
        mapGheLichTrinh.clear(); // Clear map l∆∞u l·ªãch tr√¨nh
        
        // Clear table gi·ªè v√©
        modelGioVe.setRowCount(0);
        
        // RELOAD s∆° ƒë·ªì gh·∫ø ƒë·ªÉ reset t·∫•t c·∫£ button v·ªÅ tr·∫Øng
        if (toaDangChon != null && lichTrinhDangChon != null) {
            hienThiSoDoGheTrongPanel(toaDangChon, lichTrinhDangChon);
        }
    }
}
