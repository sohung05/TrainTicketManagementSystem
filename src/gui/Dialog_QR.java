/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JDialog.java to edit this template
 */
package gui;

import entity.*;
import dao.*;
import utils.SessionManager;

import javax.swing.*;
import javax.swing.table.DefaultTableModel;
import java.awt.*;
import java.text.NumberFormat;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;
import java.util.Locale;

/**
 *
 * @author PC
 */
public class Dialog_QR extends javax.swing.JDialog {

    // ========== BI·∫æN INSTANCE ==========
    private boolean isNhapLai = false;
    private boolean isThanhToanThanhCong = false;
    private boolean isTreoDon = false;
    
    private Gui_NhapThongTinBanVe previousGui;
    private entity.DonTreoDat donTreo;
    
    private String cccd;
    private String hoTen;
    private String sdt;
    private String email;
    private int soLuongVe;
    private double tongTien;
    private double khuyenMai; // ƒê√£ ƒë·ªïi t·ª´ String sang double
    
    private javax.swing.JTextField txtTienKhachDua;
    private NumberFormat currencyFormat;
    
    // ========== CONSTRUCTORS ==========
    
    /**
     * Creates new form Dialog_QR
     */
    public Dialog_QR(java.awt.Frame parent, boolean modal) {
        super(parent, modal);
        initComponents();
        currencyFormat = NumberFormat.getInstance(Locale.forLanguageTag("vi-VN"));
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jButton1 = new javax.swing.JButton();
        jLabel1 = new javax.swing.JLabel();
        jLabel2 = new javax.swing.JLabel();
        lblTien = new javax.swing.JLabel();
        jLabel4 = new javax.swing.JLabel();
        jLabel7 = new javax.swing.JLabel();
        jLabel9 = new javax.swing.JLabel();
        jLabel5 = new javax.swing.JLabel();
        jLabel6 = new javax.swing.JLabel();
        jLabel8 = new javax.swing.JLabel();
        btnQuayLai = new javax.swing.JButton();
        btnTreoDon = new javax.swing.JButton();
        btnThanhToan = new javax.swing.JButton();
        jLabel11 = new javax.swing.JLabel();
        jLabel10 = new javax.swing.JLabel();
        jLabel12 = new javax.swing.JLabel();
        jLabel13 = new javax.swing.JLabel();
        jLabel14 = new javax.swing.JLabel();
        pnlQR = new javax.swing.JPanel();
        jLabel16 = new javax.swing.JLabel();

        jButton1.setText("jButton1");

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);

        jLabel1.setIcon(new javax.swing.ImageIcon(getClass().getResource("/icon/qr1.png"))); // NOI18N

        jLabel2.setFont(new java.awt.Font("Segoe UI", 1, 24)); // NOI18N
        jLabel2.setText("Thanh to√°n chuy·ªÉn kho·∫£n");

        lblTien.setFont(new java.awt.Font("Segoe UI", 1, 20)); // NOI18N
        lblTien.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        lblTien.setText("200.000 VND");

        jLabel4.setText("Ch·ªß t√†i kho·∫£n:");

        jLabel7.setFont(new java.awt.Font("Segoe UI", 1, 12)); // NOI18N
        jLabel7.setText("C√îNG TY C·ªî PH·∫¶N V·∫¨N T·∫¢I ƒê∆Ø·ªúNG S·∫ÆT HKTA");

        jLabel9.setText("Ng√¢n h√†ng:");

        jLabel5.setFont(new java.awt.Font("Segoe UI", 1, 12)); // NOI18N
        jLabel5.setText("MBBank");

        jLabel6.setText("S·ªë t√†i kho·∫£n:");

        jLabel8.setFont(new java.awt.Font("Segoe UI", 1, 12)); // NOI18N
        jLabel8.setText("0766609129");

        btnQuayLai.setIcon(new javax.swing.ImageIcon(getClass().getResource("/icon/arrow.png"))); // NOI18N
        btnQuayLai.setText("Quay L·∫°i");
        btnQuayLai.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnQuayLaiActionPerformed(evt);
            }
        });

        btnTreoDon.setIcon(new javax.swing.ImageIcon(getClass().getResource("/icon/bill.png"))); // NOI18N
        btnTreoDon.setText("Treo ƒë∆°n");
        btnTreoDon.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnTreoDonActionPerformed(evt);
            }
        });

        btnThanhToan.setIcon(new javax.swing.ImageIcon(getClass().getResource("/icon/payment.png"))); // NOI18N
        btnThanhToan.setText("Thanh to√°n ");
        btnThanhToan.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnThanhToanActionPerformed(evt);
            }
        });

        jLabel11.setText("M√£ h√≥a ƒë∆°n: ");

        jLabel10.setText("CCCD:");

        jLabel12.setText("S·ªë ƒëi·ªán tho·∫°i:");

        jLabel13.setText("H·ªç t√™n:");

        jLabel14.setText("S·ªë l∆∞·ª£ng v√©:");

        javax.swing.GroupLayout pnlQRLayout = new javax.swing.GroupLayout(pnlQR);
        pnlQR.setLayout(pnlQRLayout);
        pnlQRLayout.setHorizontalGroup(
            pnlQRLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 135, Short.MAX_VALUE)
        );
        pnlQRLayout.setVerticalGroup(
            pnlQRLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 120, Short.MAX_VALUE)
        );

        jLabel16.setText("Khuy·∫øn m√£i:");

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addComponent(jLabel2)
                .addGap(18, 18, 18)
                .addComponent(jLabel1)
                .addGap(123, 123, 123))
            .addGroup(layout.createSequentialGroup()
                .addGap(61, 61, 61)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(jLabel14)
                            .addComponent(jLabel12)
                            .addGroup(layout.createSequentialGroup()
                                .addComponent(btnQuayLai)
                                .addGap(58, 58, 58)
                                .addComponent(btnTreoDon)
                                .addGap(55, 55, 55)
                                .addComponent(btnThanhToan))
                            .addGroup(layout.createSequentialGroup()
                                .addComponent(pnlQR, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addGap(35, 35, 35)
                                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                    .addGroup(layout.createSequentialGroup()
                                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING, false)
                                            .addComponent(jLabel6, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                                            .addComponent(jLabel4, javax.swing.GroupLayout.Alignment.LEADING))
                                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                            .addGroup(layout.createSequentialGroup()
                                                .addGap(3, 3, 3)
                                                .addComponent(jLabel8))
                                            .addGroup(layout.createSequentialGroup()
                                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                                .addComponent(jLabel7))))
                                    .addGroup(layout.createSequentialGroup()
                                        .addComponent(jLabel9)
                                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                        .addComponent(jLabel5, javax.swing.GroupLayout.PREFERRED_SIZE, 50, javax.swing.GroupLayout.PREFERRED_SIZE))
                                    .addComponent(lblTien, javax.swing.GroupLayout.PREFERRED_SIZE, 136, javax.swing.GroupLayout.PREFERRED_SIZE))))
                        .addContainerGap(14, Short.MAX_VALUE))
                    .addGroup(layout.createSequentialGroup()
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(jLabel13, javax.swing.GroupLayout.PREFERRED_SIZE, 43, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(jLabel11)
                            .addComponent(jLabel10)
                            .addComponent(jLabel16, javax.swing.GroupLayout.PREFERRED_SIZE, 66, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addGap(0, 0, Short.MAX_VALUE))))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGap(24, 24, 24)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addComponent(jLabel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(jLabel2, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                .addGap(35, 35, 35)
                .addComponent(jLabel11)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jLabel10)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jLabel13)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jLabel12)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jLabel14)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jLabel16)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 45, Short.MAX_VALUE)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                        .addComponent(lblTien)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(jLabel9)
                            .addComponent(jLabel5))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(jLabel7)
                            .addComponent(jLabel4))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(jLabel6)
                            .addComponent(jLabel8))
                        .addGap(51, 51, 51))
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                        .addComponent(pnlQR, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(34, 34, 34)))
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(btnQuayLai, javax.swing.GroupLayout.PREFERRED_SIZE, 40, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(btnTreoDon, javax.swing.GroupLayout.PREFERRED_SIZE, 40, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(btnThanhToan, javax.swing.GroupLayout.PREFERRED_SIZE, 40, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(15, 15, 15))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void btnQuayLaiActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnQuayLaiActionPerformed
        // Quay l·∫°i Gui_NhapThongTinBanVe (gi·ªØ nguy√™n d·ªØ li·ªáu ƒë√£ nh·∫≠p)
        isNhapLai = true;
        isThanhToanThanhCong = false;
        isTreoDon = false;
        dispose();
    }//GEN-LAST:event_btnQuayLaiActionPerformed

    private void btnTreoDonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnTreoDonActionPerformed
        // ‚ö° VALIDATE "ƒê·ªêI T∆Ø·ª¢NG" TR∆Ø·ªöC KHI TREO ƒê∆†N
        if (previousGui != null) {
            javax.swing.table.TableModel model = previousGui.getModelThongTinVe();
            for (int i = 0; i < model.getRowCount(); i++) {
                String doiTuong = model.getValueAt(i, 2) != null ? model.getValueAt(i, 2).toString().trim() : "";
                if (doiTuong.isEmpty()) {
                    JOptionPane.showMessageDialog(this,
                        "Vui l√≤ng ch·ªçn ƒê·ªëi t∆∞·ª£ng cho v√© ·ªü d√≤ng " + (i + 1) + " tr∆∞·ªõc khi treo ƒë∆°n!",
                        "Thi·∫øu th√¥ng tin",
                        JOptionPane.WARNING_MESSAGE);
                    return;
                }
            }
        }

        // L∆∞u ƒë∆°n treo
        entity.DonTreoDat donTreo = new entity.DonTreoDat();
        donTreo.setCccdNguoiDat(cccd);
        donTreo.setHoTenNguoiDat(hoTen);
        donTreo.setSdtNguoiDat(sdt);
        donTreo.setEmailNguoiDat(email);
        donTreo.setSoLuongVe(soLuongVe);
        donTreo.setTongTien(tongTien);

        // ‚ö° L∆∞u th√¥ng tin ga ƒëi, ga ƒë·∫øn v√† LichTrinh
        if (previousGui != null) {
            try {
                entity.LichTrinh lt = previousGui.getPreviousGuiBanVe().getLichTrinhDangChon();
                if (lt != null) {
                    String gaDi = lt.getGaDi() != null ? lt.getGaDi().getTenGa() : "";
                    String gaDen = lt.getGaDen() != null ? lt.getGaDen().getTenGa() : "";
                    donTreo.setGaDi(gaDi);
                    donTreo.setGaDen(gaDen);

                    // ‚ö° L∆ØU LICH TRINH (quan tr·ªçng ƒë·ªÉ l∆∞u v√© v√†o database)
                    donTreo.setLichTrinh(lt);
                }
            } catch (Exception e) {
                System.out.println("Kh√¥ng l·∫•y ƒë∆∞·ª£c th√¥ng tin ga: " + e.getMessage());
            }
        }

        // L·∫•y th√¥ng tin v√© t·ª´ Gui_NhapThongTinBanVe
        if (previousGui != null) {
            // L·∫•y d·ªØ li·ªáu t·ª´ b·∫£ng v√©
            javax.swing.table.TableModel model = previousGui.getModelThongTinVe();

            // ‚ö° L·∫§Y T·ª™ GUI_NHAPTHONGTINBANVE (kh√¥ng ph·∫£i t·ª´ Gui_BanVe v√¨ ƒë√£ b·ªã clear)
            java.util.List<entity.ChoNgoi> danhSachChoNgoi = previousGui.getDanhSachChoNgoi();

            // ‚ö° L·∫•y danh s√°ch l·ªãch tr√¨nh (quan tr·ªçng cho kh·ª© h·ªìi)
            java.util.List<entity.LichTrinh> danhSachLichTrinh = previousGui.getDanhSachLichTrinh();
            System.out.println("üü° DEBUG TREO ƒê∆†N: S·ªë v√© trong table = " + model.getRowCount());
            System.out.println("üü° DEBUG TREO ƒê∆†N: S·ªë gh·∫ø (ChoNgoi) = " + (danhSachChoNgoi != null ? danhSachChoNgoi.size() : "null"));
            System.out.println("üü° DEBUG TREO ƒê∆†N: S·ªë l·ªãch tr√¨nh = " + (danhSachLichTrinh != null ? danhSachLichTrinh.size() : "null"));

            for (int i = 0; i < model.getRowCount(); i++) {
                entity.DonTreoDat.ThongTinVeTam veTam = new entity.DonTreoDat.ThongTinVeTam();

                Object soGiayTo = model.getValueAt(i, 0);
                Object hoTenVe = model.getValueAt(i, 1);
                Object doiTuong = model.getValueAt(i, 2);
                Object thongTinCho = model.getValueAt(i, 3);
                Object giaVe = model.getValueAt(i, 4);
                Object giamGia = model.getValueAt(i, 5);
                Object thanhTien = model.getValueAt(i, 6);

                veTam.setSoGiayTo(soGiayTo != null ? soGiayTo.toString() : "");
                veTam.setHoTen(hoTenVe != null ? hoTenVe.toString() : "");
                veTam.setDoiTuong(doiTuong != null ? doiTuong.toString() : "");
                veTam.setThongTinCho(thongTinCho != null ? thongTinCho.toString() : "");

                // ‚ö° L∆ØU TH√îNG TIN GH·∫æ (ƒë·ªÉ khi thanh to√°n c√≥ th·ªÉ l∆∞u v√†o database)
                if (danhSachChoNgoi != null && i < danhSachChoNgoi.size()) {
                    veTam.setChoNgoi(danhSachChoNgoi.get(i));
                    System.out.println("üü° V√© #" + i + ": ChoNgoi = " + danhSachChoNgoi.get(i).getMaChoNgoi());
                } else {
                    System.out.println("‚ùå V√© #" + i + ": KH√îNG C√ì ChoNgoi!");
                }

                // ‚ö° L∆ØU L·ªäCH TR√åNH CHO T·ª™NG V√â (quan tr·ªçng v·ªõi kh·ª© h·ªìi)
                if (danhSachLichTrinh != null && i < danhSachLichTrinh.size()) {
                    veTam.setLichTrinh(danhSachLichTrinh.get(i));
                    System.out.println("üü° V√© #" + i + ": LichTrinh = " + danhSachLichTrinh.get(i).getMaLichTrinh());
                } else {
                    System.out.println("‚ùå V√© #" + i + ": KH√îNG C√ì LichTrinh!");
                }

                try {
                    veTam.setGiaVe(giaVe != null ? Double.parseDouble(giaVe.toString()) : 0);
                    veTam.setGiamGia(giamGia != null ? Double.parseDouble(giamGia.toString()) : 0);
                    veTam.setThanhTien(thanhTien != null ? Double.parseDouble(thanhTien.toString()) : 0);
                } catch (Exception e) {
                    veTam.setGiaVe(0);
                    veTam.setGiamGia(0);
                    veTam.setThanhTien(0);
                }

                donTreo.themVe(veTam);
            }
        }

        // ‚ö†Ô∏è QUAN TR·ªåNG: Th√™m ƒë∆°n treo V√ÄO DANH S√ÅCH TR∆Ø·ªöC ƒë·ªÉ t·∫°o maDonTreo
        QuanLyDonTreo.themDonTreo(donTreo);

        // SAU ƒê√ì m·ªõi l∆∞u gh·∫ø v√†o danh s√°ch gi·ªØ ch·ªó (v·ªõi maDonTreo ƒë√£ ƒë∆∞·ª£c set)
        // ‚ö° L∆∞u gh·∫ø v·ªõi maLichTrinh ƒë·ªÉ h·ªó tr·ª£ kh·ª© h·ªìi
        if (previousGui != null) {
            System.out.println("üü° ============ B·∫ÆT ƒê·∫¶U TREO ƒê∆†N ============");
            for (entity.DonTreoDat.ThongTinVeTam veTam : donTreo.getDanhSachVe()) {
                if (veTam.getChoNgoi() != null) {
                    String maChoNgoi = veTam.getChoNgoi().getMaChoNgoi();
                    String maLichTrinh = veTam.getLichTrinh() != null ? veTam.getLichTrinh().getMaLichTrinh() : null;
                    System.out.println("üü° TREO GH·∫æ: " + maChoNgoi + " | L·ªãch tr√¨nh: " + maLichTrinh);
                    QuanLyGheGiuCho.themGheGiuCho(maChoNgoi, donTreo.getMaDonTreo(), maLichTrinh);
                }
            }
            System.out.println("üü° ============ K·∫æT TH√öC TREO ƒê∆†N ============");
        }

        isTreoDon = true;
        isThanhToanThanhCong = false;
        isNhapLai = false;

        // ‚ö° RELOAD S∆† ƒê·ªí GH·∫æ SAU KHI TREO ƒê∆†N ƒë·ªÉ hi·ªÉn th·ªã gh·∫ø m√†u v√†ng
        Gui_BanVe guiBanVeToReload = null;
        try {
            if (previousGui != null && previousGui.getPreviousGuiBanVe() != null) {
                guiBanVeToReload = previousGui.getPreviousGuiBanVe();
            }
        } catch (Exception e) {
            System.err.println("Kh√¥ng t√¨m th·∫•y Gui_BanVe: " + e.getMessage());
        }

        final Gui_BanVe finalGuiBanVe = guiBanVeToReload;
        if (finalGuiBanVe != null) {
            javax.swing.SwingUtilities.invokeLater(() -> {
                System.out.println("üü° ƒêang reload s∆° ƒë·ªì gh·∫ø sau khi TREO ƒê∆†N...");
                finalGuiBanVe.reloadSoDoGhe();
                System.out.println("‚úÖ ƒê√£ reload s∆° ƒë·ªì gh·∫ø - gh·∫ø gi·ªØ ch·ªó hi·ªÉn th·ªã m√†u v√†ng!");
            });
        }

        dispose();
    }//GEN-LAST:event_btnTreoDonActionPerformed

    private void btnThanhToanActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnThanhToanActionPerformed
        // Validate d·ªØ li·ªáu
        String tienKhachDuaText = txtTienKhachDua.getText().trim();

        if (tienKhachDuaText.isEmpty()) {
            JOptionPane.showMessageDialog(this,
                "Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn kh√°ch ƒë∆∞a!",
                "L·ªói",
                JOptionPane.ERROR_MESSAGE);
            txtTienKhachDua.requestFocus();
            return;
        }

        try {
            // X√≥a d·∫•u ph√¢n c√°ch
            tienKhachDuaText = tienKhachDuaText.replaceAll("[,.]", "");
            double tienKhachDua = Double.parseDouble(tienKhachDuaText);
            double tongThanhToan = tongTien - khuyenMai;

            if (tienKhachDua < tongThanhToan) {
                JOptionPane.showMessageDialog(this,
                    "S·ªë ti·ªÅn kh√°ch ƒë∆∞a kh√¥ng ƒë·ªß!\n" +
                    "C·∫ßn thanh to√°n: " + currencyFormat.format(tongThanhToan) + " ‚Ç´\n" +
                    "Kh√°ch ƒë∆∞a: " + currencyFormat.format(tienKhachDua) + " ‚Ç´\n" +
                    "Thi·∫øu: " + currencyFormat.format(tongThanhToan - tienKhachDua) + " ‚Ç´",
                    "L·ªói",
                    JOptionPane.ERROR_MESSAGE);
                return;
            }

            // ‚ö° VALIDATE "ƒê·ªêI T∆Ø·ª¢NG" - Ki·ªÉm tra t·∫•t c·∫£ v√© ƒë√£ ch·ªçn ƒë·ªëi t∆∞·ª£ng
            if (previousGui != null) {
                javax.swing.table.TableModel model = previousGui.getModelThongTinVe();
                for (int i = 0; i < model.getRowCount(); i++) {
                    String doiTuong = model.getValueAt(i, 2) != null ? model.getValueAt(i, 2).toString().trim() : "";
                    if (doiTuong.isEmpty()) {
                        JOptionPane.showMessageDialog(this,
                            "Vui l√≤ng ch·ªçn ƒê·ªëi t∆∞·ª£ng cho v√© ·ªü d√≤ng " + (i + 1) + "!",
                            "Thi·∫øu th√¥ng tin",
                            JOptionPane.WARNING_MESSAGE);
                        return;
                    }
                }
            }

            // ============ L∆ØU V√ÄO DATABASE ============
            String maHoaDon = "HD" + System.currentTimeMillis();
            boolean luuThanhCong = luuVaoDatabase(maHoaDon, cccd, hoTen, sdt, email, soLuongVe, tongTien, khuyenMai);

            if (!luuThanhCong) {
                JOptionPane.showMessageDialog(this,
                    "L·ªói l∆∞u d·ªØ li·ªáu v√†o database!\nVui l√≤ng th·ª≠ l·∫°i.",
                    "L·ªói",
                    JOptionPane.ERROR_MESSAGE);
                return;
            }

            isThanhToanThanhCong = true;
            isNhapLai = false;
            isTreoDon = false;

            // L∆∞u parentFrame tr∆∞·ªõc khi dispose
            java.awt.Frame parentFrame = (java.awt.Frame) javax.swing.SwingUtilities.getWindowAncestor(this);

            // ƒê√≥ng dialog thanh to√°n
            dispose();

            // ‚ö° M·ªû DIALOG IN ƒë·ªÉ h·ªèi ng∆∞·ªùi d√πng
            Dialog_In dialogIn = new Dialog_In(parentFrame, true, maHoaDon);
            dialogIn.setVisible(true);

            // ‚ö° RELOAD s∆° ƒë·ªì gh·∫ø ƒë·ªÉ c·∫≠p nh·∫≠t gh·∫ø ƒë√£ b√°n (m√†u ƒë·ªè)
            Gui_BanVe guiBanVeToReload = null;

            if (previousGui != null) {
                // Tr∆∞·ªùng h·ª£p b√°n v√© th∆∞·ªùng
                guiBanVeToReload = previousGui.getPreviousGuiBanVe();
                if (guiBanVeToReload != null) {
                    // ‚ö° KH√îNG g·ªçi xoaTatCaGheDaChon() ·ªü ƒë√¢y v√¨ n√≥ c√≥ reload b√™n trong
                    // S·∫Ω g·ªçi reloadSoDoGhe() sau ƒë·ªÉ ƒë·∫£m b·∫£o database ƒë√£ commit
                    // reloadSoDoGhe() s·∫Ω t·ª± ƒë·ªông clear danh s√°ch gh·∫ø v√† gi·ªè v√©

                    // Quay v·ªÅ Gui_BanVe
                    gui.menu.form.MainForm mainForm =
                    (gui.menu.form.MainForm) javax.swing.SwingUtilities.getAncestorOfClass(
                        gui.menu.form.MainForm.class, previousGui);

                    if (mainForm != null) {
                        mainForm.showForm(guiBanVeToReload);
                    }
                }
            } else if (donTreo != null) {
                // ‚ö° Tr∆∞·ªùng h·ª£p x·ª≠ l√Ω ƒë∆°n t·∫°m ‚Üí T√¨m Gui_BanVe ƒë·ªÉ reload
                System.out.println("üîµ X·ª≠ l√Ω ƒë∆°n treo - T√¨m Gui_BanVe ƒë·ªÉ reload...");
                try {
                    // T√¨m MainForm
                    gui.menu.form.MainForm mainForm = null;
                    for (java.awt.Window window : java.awt.Window.getWindows()) {
                        if (window instanceof javax.swing.JFrame) {
                            javax.swing.JFrame frame = (javax.swing.JFrame) window;
                            java.awt.Component comp = frame.getContentPane().getComponent(0);
                            if (comp instanceof gui.menu.form.MainForm) {
                                mainForm = (gui.menu.form.MainForm) comp;
                                break;
                            }
                        }
                    }

                    if (mainForm != null) {
                        guiBanVeToReload = findGuiBanVeInMainForm(mainForm);
                        if (guiBanVeToReload != null) {
                            System.out.println("‚úÖ T√¨m th·∫•y Gui_BanVe!");
                        } else {
                            System.out.println("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y Gui_BanVe trong MainForm");
                        }
                    } else {
                        System.out.println("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y MainForm");
                    }
                } catch (Exception e) {
                    System.err.println("‚ùå L·ªói khi t√¨m Gui_BanVe: " + e.getMessage());
                    e.printStackTrace();
                }
            }

            // Reload s∆° ƒë·ªì gh·∫ø SAU KHI l∆∞u database
            // ‚ö° S·ª≠ d·ª•ng invokeLater ƒë·ªÉ ƒë·∫£m b·∫£o reload sau khi database ƒë√£ commit
            final Gui_BanVe finalGuiBanVeToReload = guiBanVeToReload;
            final boolean isFromDonTreo = (donTreo != null);

            if (finalGuiBanVeToReload != null) {
                javax.swing.SwingUtilities.invokeLater(() -> {
                    System.out.println("üîÑ ƒêang reload s∆° ƒë·ªì gh·∫ø sau khi thanh to√°n...");
                    entity.LichTrinh ltHienTai = finalGuiBanVeToReload.getLichTrinhDangChon();
                    if (ltHienTai != null) {
                        System.out.println("üìç L·ªãch tr√¨nh ƒëang hi·ªÉn th·ªã: " + ltHienTai.getMaLichTrinh());
                    }
                    finalGuiBanVeToReload.reloadSoDoGhe();
                    System.out.println("‚úÖ ƒê√£ reload s∆° ƒë·ªì gh·∫ø!");
                    System.out.println("üí° L∆ØU √ù: N·∫øu ƒë∆°n kh·ª© h·ªìi, chuy·ªÉn sang chi·ªÅu kia s·∫Ω t·ª± ƒë·ªông hi·ªÉn th·ªã m√†u ƒë·ªè khi query database!");
                });
            } else if (isFromDonTreo) {
                // ‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y Gui_BanVe ‚Üí Th√¥ng b√°o cho user
                System.out.println("‚ö†Ô∏è Kh√¥ng th·ªÉ reload s∆° ƒë·ªì gh·∫ø v√¨ Gui_BanVe ch∆∞a m·ªü");
                System.out.println("üí° V√© ƒë√£ l∆∞u v√†o database. Khi m·ªü l·∫°i m√†n h√¨nh b√°n v√©, gh·∫ø s·∫Ω hi·ªÉn th·ªã m√†u ƒë·ªè.");
            }

        } catch (NumberFormatException e) {
            JOptionPane.showMessageDialog(this,
                "S·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá!",
                "L·ªói",
                JOptionPane.ERROR_MESSAGE);
        }
    }//GEN-LAST:event_btnThanhToanActionPerformed

    /**
     * @param args the command line arguments
     */
    public static void main(String args[]) {
        /* Set the Nimbus look and feel */
        //<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
        /* If Nimbus (introduced in Java SE 6) is not available, stay with the default look and feel.
         * For details see http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html 
         */
        try {
            for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
                if ("Nimbus".equals(info.getName())) {
                    javax.swing.UIManager.setLookAndFeel(info.getClassName());
                    break;
                }
            }
        } catch (ClassNotFoundException ex) {
            java.util.logging.Logger.getLogger(Dialog_QR.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (InstantiationException ex) {
            java.util.logging.Logger.getLogger(Dialog_QR.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (IllegalAccessException ex) {
            java.util.logging.Logger.getLogger(Dialog_QR.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (javax.swing.UnsupportedLookAndFeelException ex) {
            java.util.logging.Logger.getLogger(Dialog_QR.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        }
        //</editor-fold>

        /* Create and display the dialog */
        java.awt.EventQueue.invokeLater(new Runnable() {
            public void run() {
                Dialog_QR dialog = new Dialog_QR(new javax.swing.JFrame(), true);
                dialog.addWindowListener(new java.awt.event.WindowAdapter() {
                    @Override
                    public void windowClosing(java.awt.event.WindowEvent e) {
                        System.exit(0);
                    }
                });
                dialog.setVisible(true);
            }
        });
    }
    
    // ========== GETTER METHODS ==========
    
    public boolean isNhapLai() {
        return isNhapLai;
    }
    
    public boolean isThanhToanThanhCong() {
        return isThanhToanThanhCong;
    }
    
    public boolean isTreoDon() {
        return isTreoDon;
    }
    
    public entity.DonTreoDat getDonTreo() {
        return donTreo;
    }
    
    // ========== HELPER METHODS ==========
    
    /**
     * T√¨m Gui_BanVe trong container (ƒë·ªá quy)
     */
    private Gui_BanVe findGuiBanVe(Container container) {
        for (Component comp : container.getComponents()) {
            if (comp instanceof Gui_BanVe) {
                return (Gui_BanVe) comp;
            } else if (comp instanceof Container) {
                Gui_BanVe result = findGuiBanVe((Container) comp);
                if (result != null) {
                    return result;
                }
            }
        }
        return null;
    }
    
    /**
     * T√¨m Gui_BanVe trong MainForm (d√πng cho x·ª≠ l√Ω ƒë∆°n treo)
     */
    private Gui_BanVe findGuiBanVeInMainForm(gui.menu.form.MainForm mainForm) {
        try {
            // MainForm th∆∞·ªùng c√≥ c·∫•u tr√∫c: MainForm -> Body (JPanel) -> CurrentForm
            Component[] components = mainForm.getComponents();
            for (Component comp : components) {
                if (comp instanceof Container) {
                    Gui_BanVe result = findGuiBanVe((Container) comp);
                    if (result != null) {
                        return result;
                    }
                }
            }
        } catch (Exception e) {
            System.err.println("L·ªói khi t√¨m Gui_BanVe: " + e.getMessage());
        }
        return null;
    }
    
    /**
     * L∆∞u d·ªØ li·ªáu v√†o database
     * @return true n·∫øu th√†nh c√¥ng
     */
    private boolean luuVaoDatabase(String maHoaDon, String cccd, String hoTen, String sdt, String email, 
                                     int soLuongVe, double tongTien, double khuyenMai) {
        try {
            // ===== 1. T·∫†O/L·∫§Y KH√ÅCH H√ÄNG =====
            KhachHang_DAO khachHangDAO = new KhachHang_DAO();
            KhachHang kh = khachHangDAO.findByCCCD(cccd);
            
            if (kh == null) {
                // T·∫°o kh√°ch h√†ng m·ªõi
                kh = new KhachHang();
                kh.setMaKH("KH" + System.currentTimeMillis());
                kh.setCCCD(cccd);
                kh.setHoTen(hoTen);
                kh.setSDT(sdt);
                kh.setEmail(email);
                kh.setDoiTuong(null);
                
                if (!khachHangDAO.them(kh)) {
                    System.out.println("L·ªói: Kh√¥ng th·ªÉ t·∫°o kh√°ch h√†ng!");
                    return false;
                }
            }
            
            // ===== 2. T·∫†O H√ìA ƒê∆†N =====
            HoaDon hoaDon = new HoaDon();
            hoaDon.setMaHoaDon(maHoaDon);
            
            // L·∫•y nh√¢n vi√™n t·ª´ session
            NhanVien nv = new NhanVien();
            nv.setMaNhanVien(SessionManager.getInstance().getMaNhanVienDangNhap());
            hoaDon.setNhanVien(nv);
            
            hoaDon.setKhachHang(kh);
            hoaDon.setNgayTao(LocalDateTime.now());
            hoaDon.setGioTao(LocalDateTime.now());
            hoaDon.setTongTien(tongTien - khuyenMai);
            hoaDon.setTrangThai(true);
            
            HoaDon_DAO hoaDonDAO = new HoaDon_DAO();
            if (!hoaDonDAO.insertHoaDon(hoaDon)) {
                System.out.println("L·ªói: Kh√¥ng th·ªÉ t·∫°o h√≥a ƒë∆°n!");
                return false;
            }
            
            // ===== 3. L∆ØU V√â V√Ä CHI TI·∫æT H√ìA ƒê∆†N =====
            Ve_DAO veDAO = new Ve_DAO();
            ChiTietHoaDon_DAO chiTietDAO = new ChiTietHoaDon_DAO();
            LoaiVe_DAO loaiVeDAO = new LoaiVe_DAO();
            
            // L·∫•y danh s√°ch v√© t·ª´ donTreo
            if (donTreo != null) {
                List<DonTreoDat.ThongTinVeTam> danhSachVe = donTreo.getDanhSachVe();
                System.out.println("üí≥ ========== THANH TO√ÅN ƒê∆†N TREO ==========");
                System.out.println("üí≥ S·ªë v√© trong ƒë∆°n: " + danhSachVe.size());
                
                for (int i = 0; i < danhSachVe.size(); i++) {
                    DonTreoDat.ThongTinVeTam veTam = danhSachVe.get(i);
                    
                    // L·∫•y LoaiVe
                    LoaiVe loaiVe = loaiVeDAO.findByTenLoaiVe(veTam.getDoiTuong());
                    
                    if (loaiVe == null) {
                        System.out.println("‚ùå L·ªñI: Kh√¥ng t√¨m th·∫•y lo·∫°i v√© '" + veTam.getDoiTuong() + "' trong database!");
                        return false;
                    }
                    
                    // L·∫•y l·ªãch tr√¨nh t·ª´ v√© t·∫°m
                    LichTrinh lichTrinhCuaVe = veTam.getLichTrinh();
                    if (lichTrinhCuaVe == null) {
                        System.out.println("‚ùå L·ªñI: V√© #" + i + " kh√¥ng c√≥ l·ªãch tr√¨nh!");
                        return false;
                    }
                    
                    // T·∫°o V√©
                    Ve ve = new Ve();
                    String maVe = "V" + System.currentTimeMillis() + "_" + i;
                    ve.setMaVe(maVe);
                    ve.setLoaiVe(loaiVe);
                    ve.setMaVach(null);
                    ve.setThoiGianLenTau(LocalDateTime.now());
                    ve.setGiaVe(veTam.getGiaVe());
                    ve.setKhachHang(kh);
                    ve.setChoNgoi(veTam.getChoNgoi());
                    ve.setLichTrinh(lichTrinhCuaVe);
                    ve.setTrangThai(true);
                    ve.setTenKhachHang(veTam.getHoTen());
                    ve.setSoCCCD(veTam.getSoGiayTo());
                    
                    if (!veDAO.insert(ve)) {
                        System.out.println("L·ªói: Kh√¥ng th·ªÉ l∆∞u v√© t·ª´ ƒë∆°n treo");
                        return false;
                    }
                    
                    // T·∫°o ChiTietHoaDon
                    ChiTietHoaDon cthd = new ChiTietHoaDon();
                    cthd.setMaHoaDon(maHoaDon);
                    cthd.setMaVe(ve.getMaVe());
                    cthd.setSoLuong(1);
                    cthd.setGiaVe(veTam.getGiaVe());
                    cthd.setMucGiam(veTam.getGiamGia());
                    
                    if (!chiTietDAO.insert(cthd)) {
                        System.out.println("L·ªói: Kh√¥ng th·ªÉ l∆∞u chi ti·∫øt h√≥a ƒë∆°n t·ª´ ƒë∆°n treo");
                        return false;
                    }
                }
            }
            
            System.out.println("‚úÖ L∆∞u database th√†nh c√¥ng! M√£ h√≥a ƒë∆°n: " + maHoaDon);
            return true;
            
        } catch (Exception e) {
            e.printStackTrace();
            System.out.println("‚ùå L·ªñI: " + e.getMessage());
            return false;
        }
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnQuayLai;
    private javax.swing.JButton btnThanhToan;
    private javax.swing.JButton btnTreoDon;
    private javax.swing.JButton jButton1;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel10;
    private javax.swing.JLabel jLabel11;
    private javax.swing.JLabel jLabel12;
    private javax.swing.JLabel jLabel13;
    private javax.swing.JLabel jLabel14;
    private javax.swing.JLabel jLabel16;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JLabel jLabel7;
    private javax.swing.JLabel jLabel8;
    private javax.swing.JLabel jLabel9;
    private javax.swing.JLabel lblTien;
    private javax.swing.JPanel pnlQR;
    // End of variables declaration//GEN-END:variables
}
